<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L2 Interlude Craft Calculator</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f172a;
      --panel:#1e293b;
      --panel2:#0b1224;
      --text:#e5e7eb;
      --muted:#93a4b8;
      --accent:#fbbf24;
      --line:#334155;
    }
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      padding:16px;
    }
    h1{font-size:18px;margin:0 0 10px 0;}

    .tabs{display:flex;gap:8px;margin-bottom:10px;}
    .tab{
      padding:8px 12px;border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2); color:var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .tab.active{background:var(--panel);}

    input{
      width:100%;
      padding:10px;
      font-size:16px;
      margin:0 0 10px 0;
      border-radius:8px;
      border:1px solid var(--line);
      background:#ffffff;
      color:#111827;
      box-sizing:border-box;
    }

    .meta{
      font-size:12px;color:var(--muted);
      margin:0 0 8px 0;
      white-space:pre-wrap;
    }

    .list .row{
      background:var(--panel);
      padding:10px 12px;
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
      border:1px solid #23324a;
    }
    .list .row:hover{background:var(--line);}

    .rowline{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .title{
      font-size:14px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .qty{
      font-weight:700; color:var(--accent);
      min-width:60px;
      text-align:right;
    }
    .tag{
      font-size:11px; color:var(--muted);
      min-width:44px; text-align:right;
    }

    .back{
      display:inline-block;
      margin:0 0 10px 0;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
    }

    .tip{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }

    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .btn:hover{background:var(--line);}

    .indent{margin-left:18px;border-left:2px solid #24344f;padding-left:10px;}
  </style>
</head>

<body>
  <h1>L2 Interlude Craft Calculator</h1>

  <div class="tabs">
    <button class="tab active" id="tabWeapons">Weapons</button>
  </div>

  <input id="search" type="text" placeholder="Search weapon (Arcana / Аркана)"/>

  <div class="meta" id="status">Loading data...</div>

  <div id="viewList" class="list"></div>
  <div id="viewDetails" style="display:none;"></div>

<script>
/* ==========================
   0) ВСТАВЬ СВОИ CSV ССЫЛКИ
   ========================== */
const ITEMS_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv';
const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv';

/* ==========================
   1) GLOBAL STATE
   ========================== */
let ITEMS = [];
let RECIPES = [];

const itemsById = new Map();          // id -> item
const recipeMap = new Map();          // item_id -> array of {component_id, qty}
let currentTab = 'weapon';
let currentList = [];                // filtered list for tab
let currentItemId = null;            // opened details root
const expanded = new Set();          // expanded node keys

const elSearch  = document.getElementById('search');
const elStatus  = document.getElementById('status');
const elList    = document.getElementById('viewList');
const elDetails = document.getElementById('viewDetails');

document.getElementById('tabWeapons').addEventListener('click', () => {
  setTab('weapon');
});

/* ==========================
   2) CSV PARSER (с кавычками)
   ========================== */
function parseCSV(text){
  // robust enough for quotes + commas
  const rows = [];
  let row = [];
  let cur = '';
  let inQuotes = false;

  for (let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];

    if (ch === '"' && inQuotes && next === '"'){ // escaped quote
      cur += '"'; i++;
      continue;
    }
    if (ch === '"'){
      inQuotes = !inQuotes;
      continue;
    }
    if (ch === ',' && !inQuotes){
      row.push(cur);
      cur = '';
      continue;
    }
    if ((ch === '\n' || ch === '\r') && !inQuotes){
      if (ch === '\r' && next === '\n'){ i++; }
      row.push(cur);
      cur = '';
      // skip empty last line
      if (row.length === 1 && row[0].trim() === ''){
        row = [];
        continue;
      }
      rows.push(row);
      row = [];
      continue;
    }
    cur += ch;
  }
  if (cur.length || row.length){
    row.push(cur);
    rows.push(row);
  }

  if (!rows.length) return [];
  const headers = rows[0].map(h => (h||'').trim());
  const out = [];

  for (let r=1; r<rows.length; r++){
    const vals = rows[r];
    if (!vals || !vals.length) continue;
    const obj = {};
    for (let c=0; c<headers.length; c++){
      const key = headers[c];
      obj[key] = (vals[c] ?? '').trim();
    }
    out.push(obj);
  }
  return out;
}

async function loadCSV(url){
  // cache buster to avoid stale data
  const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  const res = await fetch(url + bust, { cache: 'no-store' });
  if (!res.ok) throw new Error('Fetch failed: ' + res.status);
  const text = await res.text();
  return parseCSV(text);
}

/* ==========================
   3) NORMALIZERS
   ========================== */
function getId(obj){
  return String(obj.id ?? obj.item_id ?? '').trim();
}
function getNameEN(item){
  return (item.name_en ?? item.en ?? item.nameEN ?? '').trim();
}
function getNameRU(item){
  return (item.name_ru ?? item.ru ?? item.nameRU ?? '').trim();
}
function getCategory(item){
  // support both category and type
  return String((item.category ?? item.type ?? '')).trim().toLowerCase();
}
function isCraftable(item){
  // craftable: yes/true/1 ; or is_base: false
  const c = String(item.craftable ?? '').trim().toLowerCase();
  if (c === 'yes' || c === 'true' || c === '1') return true;
  const isBase = String(item.is_base ?? '').trim().toLowerCase();
  if (isBase === 'true' || isBase === '1' || isBase === 'yes') return false;
  // if recipe exists, also treat as craftable
  const id = String(item.id ?? '').trim();
  return recipeMap.has(id);
}

function labelItem(item){
  const en = getNameEN(item);
  const ru = getNameRU(item);
  if (en && ru) return `${en} — ${ru}`;
  return en || ru || '(no name)';
}

/* ==========================
   4) BUILD INDEXES
   ========================== */
function buildIndexes(){
  itemsById.clear();
  recipeMap.clear();

  for (const it of ITEMS){
    const id = String(it.id ?? '').trim();
    if (!id) continue;
    itemsById.set(id, it);
  }

  for (const r of RECIPES){
    const itemId = String(r.item_id ?? '').trim();
    const compId = String(r.component_id ?? '').trim();
    const qty    = Number(String(r.qty ?? '0').trim()) || 0;
    if (!itemId || !compId || !qty) continue;
    if (!recipeMap.has(itemId)) recipeMap.set(itemId, []);
    recipeMap.get(itemId).push({ component_id: compId, qty });
  }
}

/* ==========================
   5) UI: TAB + LIST
   ========================== */
function setTab(tab){
  currentTab = tab;
  document.getElementById('tabWeapons').classList.toggle('active', tab === 'weapon');
  elSearch.value = '';
  currentItemId = null;
  expanded.clear();
  showList();
}

function showList(){
  elDetails.style.display = 'none';
  elList.style.display = 'block';

  // filter by tab category
  const filtered = ITEMS.filter(it => getCategory(it) === currentTab);
  currentList = filtered;

  const count = filtered.length;
  const msg = (count === 0)
    ? `Weapons: 0\nNo weapons found. Проверь в таблице Items: у оружия category или type должно быть "weapon".`
    : `Weapons: ${count}`;
  elStatus.textContent = msg;

  renderList(filtered, elSearch.value.trim());
}

function renderList(list, q){
  const qq = q.toLowerCase();
  const shown = !qq ? list : list.filter(it => {
    const en = getNameEN(it).toLowerCase();
    const ru = getNameRU(it).toLowerCase();
    return en.includes(qq) || ru.includes(qq);
  });

  elList.innerHTML = '';
  for (const it of shown){
    const row = document.createElement('div');
    row.className = 'row';
    row.innerHTML = `<div class="rowline">
        <div class="title">${escapeHtml(labelItem(it))}</div>
        <div class="tag">${escapeHtml((it.grade ?? it.rank ?? '').toString())}</div>
      </div>`;
    row.addEventListener('click', () => openDetails(String(it.id).trim()));
    elList.appendChild(row);
  }

  if (shown.length === 0){
    const empty = document.createElement('div');
    empty.className = 'meta';
    empty.textContent = 'Nothing found.';
    elList.appendChild(empty);
  }
}

elSearch.addEventListener('input', () => renderList(currentList, elSearch.value.trim()));

/* ==========================
   6) DETAILS + TREE
   ========================== */
function openDetails(itemId){
  currentItemId = itemId;
  elList.style.display = 'none';
  elDetails.style.display = 'block';
  renderDetails();
}

function renderDetails(){
  const root = itemsById.get(currentItemId);
  if (!root){
    elDetails.innerHTML = `<div class="meta">Item not found: ${escapeHtml(currentItemId)}</div>`;
    return;
  }

  const header = `
    <button class="back" id="btnBack">◀ Back</button>
    <div class="meta">Components:</div>
    <div class="row" style="cursor:default;">
      <div class="rowline">
        <div class="title"><b>${escapeHtml(labelItem(root))}</b></div>
        <div class="tag">${escapeHtml(getCategory(root))}</div>
      </div>
    </div>
  `;

  const container = document.createElement('div');
  container.innerHTML = header;

  const treeWrap = document.createElement('div');
  treeWrap.className = 'indent';
  container.appendChild(treeWrap);

  // root components
  const comps = recipeMap.get(currentItemId) || [];
  if (comps.length === 0){
    treeWrap.innerHTML = `<div class="meta">No recipe for this item.</div>`;
  } else {
    for (const c of comps){
      const node = renderNode(c.component_id, c.qty, currentItemId + '>' + c.component_id);
      treeWrap.appendChild(node);
    }
    const tip = document.createElement('div');
    tip.className = 'tip';
    tip.textContent = 'Tip: Click ▶ Expand to раскрыть крафт компонента (qty будет умножаться).';
    treeWrap.appendChild(tip);
  }

  elDetails.innerHTML = '';
  elDetails.appendChild(container);

  document.getElementById('btnBack').addEventListener('click', () => showList());
}

function renderNode(itemId, qty, key){
  const item = itemsById.get(String(itemId));
  const craft = item ? isCraftable(item) : false;

  const row = document.createElement('div');
  row.className = 'row';
  row.style.cursor = 'default';

  const btn = craft
    ? `<button class="btn" data-key="${escapeHtml(key)}">${expanded.has(key) ? '▼ Collapse' : '▶ Expand'}</button>`
    : `<span class="tag">base</span>`;

  row.innerHTML = `
    <div class="rowline">
      <div class="title">${escapeHtml(item ? labelItem(item) : ('Unknown ID: ' + itemId))}</div>
      <div style="display:flex;align-items:center;gap:10px;">
        ${btn}
        <div class="qty">x${formatQty(qty)}</div>
      </div>
    </div>
  `;

  const childrenWrap = document.createElement('div');
  childrenWrap.className = 'indent';
  childrenWrap.style.display = expanded.has(key) ? 'block' : 'none';
  row.appendChild(childrenWrap);

  if (craft){
    const btnEl = row.querySelector('button.btn');
    btnEl.addEventListener('click', () => {
      if (expanded.has(key)) expanded.delete(key);
      else expanded.add(key);
      renderDetails(); // simple rerender
    });
  }

  // if expanded, render children multiplied
  if (craft && expanded.has(key)){
    const children = recipeMap.get(String(itemId)) || [];
    if (children.length === 0){
      childrenWrap.innerHTML = `<div class="meta">No recipe rows for this craftable item.</div>`;
    } else {
      for (const ch of children){
        const childQty = qty * ch.qty;
        const childKey = key + '>' + ch.component_id;
        childrenWrap.appendChild(renderNode(ch.component_id, childQty, childKey));
      }
    }
  }

  return row;
}

function formatQty(n){
  // show integers cleanly
  if (Number.isInteger(n)) return String(n);
  return String(Math.round(n * 1000) / 1000);
}

/* ==========================
   7) ESCAPE
   ========================== */
function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* ==========================
   8) INIT
   ========================== */
async function init(){
  try{
    elStatus.textContent = 'Loading data...';
    ITEMS = await loadCSV(ITEMS_URL);
    RECIPES = await loadCSV(RECIPES_URL);

    buildIndexes();

    // Debug
    console.log('ITEMS:', ITEMS);
    console.log('RECIPES:', RECIPES);

    setTab('weapon');
  }catch(e){
    console.error(e);
    elStatus.textContent = 'ERROR loading CSV. Check URLs / publish as CSV.\n' + e.message;
    elList.innerHTML = '';
  }
}

init();

/* Telegram */
try{
  const tg = window.Telegram.WebApp;
  tg.ready();
}catch(e){}
</script>

</body>
</html>
