<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L2 Interlude Craft Calculator</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --card2:#24344d; --text:#e5e7eb; --muted:#9ca3af;
      --accent:#fbbf24; --line:#334155; --btn:#0b1223; --btn2:#0a1020; --chip:#0b1a36;
    }
    body{font-family:Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:16px}
    h1{font-size:18px;margin:0 0 12px 0;font-weight:700}
    .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    .spacer{flex:1}
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px}
    .btn:hover{background:var(--btn2)}
    .btn.primary{border-color:var(--accent)}
    .btn.active{border-color:var(--accent);box-shadow:0 0 0 1px rgba(251,191,36,.25) inset}
    .input{width:100%;padding:10px;font-size:14px;margin:8px 0 12px;border-radius:8px;border:1px solid var(--line);background:rgba(255,255,255,0.04);color:var(--text);outline:none}
    .muted{color:var(--muted);font-size:12px}
    .list .item{background:var(--card);padding:10px;border-radius:10px;margin-bottom:8px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid rgba(255,255,255,.06)}
    .list .item:hover{background:var(--card2)}
    .left{display:flex;align-items:center;gap:10px;min-width:0}
    .ico{width:22px;height:22px;border-radius:6px;background:#0b1223;border:1px solid rgba(255,255,255,.08);object-fit:cover;flex:0 0 auto}
    .title{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{background:var(--chip);border:1px solid rgba(255,255,255,.08);padding:3px 8px;border-radius:999px;font-size:12px;color:var(--muted);text-transform:lowercase}
    .build{position:fixed;right:10px;bottom:10px;opacity:.45;font-size:11px;z-index:9999}
  </style>
</head>

<body>
  <h1>L2 Interlude Craft Calculator</h1>

  <div class="topbar">
    <button class="btn" id="tabAll">All</button>
    <button class="btn" id="tabWeapons">Weapons</button>
    <button class="btn" id="tabArmor">Armor</button>
    <button class="btn" id="tabJewelry">Jewelry</button>
    <button class="btn" id="tabOther">Other</button>

    <div class="spacer"></div>

    <button class="btn primary" id="btnLang">RU</button>
    <span class="muted" id="statusLine">Loading...</span>
  </div>

  <input class="input" id="searchInput" type="text" placeholder="Search (Arcana / Аркана)" />
  <div class="muted" id="countLine"></div>
  <div class="list" id="itemsList"></div>

  <div class="build">BUILD: 2026-01-02_UI_TEST</div>

  <script>
    const ITEMS_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv';
    const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv';

    let ITEMS=[], RECIPES=[];
    let lang = localStorage.getItem('l2_lang') || 'ru';
    let activeTab = localStorage.getItem('l2_tab') || 'weapons';

    function parseCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch === '"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else inQ=!inQ; continue; }
        if(ch === ',' && !inQ){ out.push(cur); cur=''; continue; }
        cur += ch;
      }
      out.push(cur);
      return out.map(s=>s.trim());
    }
    async function loadCSV(url){
      const res = await fetch(url, {cache:'no-store'});
      if(!res.ok) throw new Error('CSV fetch failed: '+res.status);
      const text = await res.text();
      const lines = text.replace(/\r/g,'').trim().split('\n');
      const headers = parseCSVLine(lines[0]);
      return lines.slice(1).filter(Boolean).map(line=>{
        const vals = parseCSVLine(line);
        const obj={};
        headers.forEach((h,i)=>obj[h]= (vals[i]??'').trim());
        return obj;
      });
    }
    function cleanPercent(s){ return String(s||'').replace(/\s*\(\s*\d+\s*%\s*\)\s*/g,' ').replace(/\s+/g,' ').trim(); }
    function label(it){
      const en=cleanPercent(it.name_en||''); const ru=cleanPercent(it.name_ru||'');
      if(lang==='en') return en || ru || ('#'+it.id);
      return ru || en || ('#'+it.id);
    }
    function makeImg(src){
      const img=document.createElement('img');
      img.className='ico'; img.src=src||''; img.alt='';
      img.onerror=()=>{img.style.visibility='hidden';};
      return img;
    }

    function isWeapon(it){ return (it.category||'').toLowerCase()==='weapon'; }
    function isArmor(it){
      const c=(it.category||'').toLowerCase();
      return c.includes('armor')||c.includes('helmet')||c.includes('gloves')||c.includes('boots')||c.includes('shield');
    }
    function isJewelry(it){
      const c=(it.category||'').toLowerCase();
      return c.includes('jewel')||c.includes('ring')||c.includes('ear')||c.includes('necklace')||c.includes('accessor');
    }
    function isOther(it){ return !isWeapon(it)&&!isArmor(it)&&!isJewelry(it); }

    function tabFilter(it){
      if(activeTab==='all') return true;
      if(activeTab==='weapons') return isWeapon(it);
      if(activeTab==='armor') return isArmor(it);
      if(activeTab==='jewelry') return isJewelry(it);
      if(activeTab==='other') return isOther(it);
      return true;
    }

    function setActiveTab(tab){
      activeTab=tab; localStorage.setItem('l2_tab',tab);
      ['tabAll','tabWeapons','tabArmor','tabJewelry','tabOther'].forEach(id=>document.getElementById(id).classList.remove('active'));
      const map={all:'tabAll',weapons:'tabWeapons',armor:'tabArmor',jewelry:'tabJewelry',other:'tabOther'};
      document.getElementById(map[tab]).classList.add('active');
      renderList();
    }

    function toggleLang(){
      lang = (lang==='ru')?'en':'ru';
      localStorage.setItem('l2_lang',lang);
      document.getElementById('btnLang').textContent = lang.toUpperCase();
      renderList();
    }

    function renderList(){
      const q=(document.getElementById('searchInput').value||'').toLowerCase().trim();
      const list=document.getElementById('itemsList'); list.innerHTML='';
      const filtered = ITEMS
        .filter(tabFilter)
        .filter(it => String(it.craftable||'').toLowerCase()==='yes') // чтобы материалы не забивали список
        .filter(it => {
          if(!q) return true;
          const s = `${it.name_en||''} ${it.name_ru||''}`.toLowerCase();
          return s.includes(q);
        });

      document.getElementById('countLine').textContent = (lang==='ru') ? `Предметов: ${filtered.length}` : `Items: ${filtered.length}`;

      for(const it of filtered){
        const row=document.createElement('div');
        row.className='item';
        const left=document.createElement('div'); left.className='left';
        left.appendChild(makeImg(it.icon));
        const t=document.createElement('div'); t.className='title'; t.textContent=label(it);
        left.appendChild(t);
        const right=document.createElement('div');
        const chip=document.createElement('span'); chip.className='chip'; chip.textContent=(it.category||'');
        right.appendChild(chip);
        row.appendChild(left); row.appendChild(right);
        list.appendChild(row);
      }
    }

    async function init(){
      document.getElementById('btnLang').textContent = lang.toUpperCase();

      document.getElementById('tabAll').onclick=()=>setActiveTab('all');
      document.getElementById('tabWeapons').onclick=()=>setActiveTab('weapons');
      document.getElementById('tabArmor').onclick=()=>setActiveTab('armor');
      document.getElementById('tabJewelry').onclick=()=>setActiveTab('jewelry');
      document.getElementById('tabOther').onclick=()=>setActiveTab('other');
      document.getElementById('btnLang').onclick=toggleLang;
      document.getElementById('searchInput').oninput=renderList;

      try{
        ITEMS = await loadCSV(ITEMS_URL);
        RECIPES = await loadCSV(RECIPES_URL); // грузим, чтобы проверить, что не падает (пока не используем)
        document.getElementById('statusLine').textContent = `Loaded: items ${ITEMS.length}, recipes ${RECIPES.length}`;
        setActiveTab(activeTab || 'weapons');
      } catch(e){
        console.error(e);
        document.getElementById('statusLine').textContent = 'Load error: ' + (e?.message||String(e));
      }

      try{
        Telegram?.WebApp?.ready();
        Telegram?.WebApp?.expand();
      }catch(e){}
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
