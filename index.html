<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L2 Interlude Craft Calculator</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f172a;
      --panel:#1e293b;
      --panel2:#0b1224;
      --text:#e5e7eb;
      --muted:#93a4b8;
      --accent:#fbbf24;
      --line:#334155;
      --danger:#7f1d1d;
    }
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      padding:16px;
    }
    h1{font-size:18px;margin:0 0 10px 0;}

    .tabs{display:flex;gap:8px;margin-bottom:10px;}
    .tab{
      padding:8px 12px;border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }
    .tab.active{background:var(--panel);}

    input{
      width:100%;
      padding:10px;
      font-size:16px;
      margin:0 0 10px 0;
      border-radius:8px;
      border:1px solid var(--line);
      background:#ffffff;
      color:#111827;
      box-sizing:border-box;
      outline:none;
    }

    .meta{
      font-size:12px;color:var(--muted);
      margin:0 0 8px 0;
      white-space:pre-wrap;
    }
    .errorBox{
      background: var(--danger);
      border:1px solid #ef4444;
      padding:10px;
      border-radius:8px;
      white-space:pre-wrap;
      margin:10px 0;
    }

    .row{
      background:var(--panel);
      padding:10px 12px;
      border-radius:8px;
      margin-bottom:8px;
      border:1px solid #23324a;
    }
    .row.clickable{cursor:pointer;}
    .row.clickable:hover{background:var(--line);}

    .rowline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      flex:1;
    }
    .title{
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .tag{
      font-size:11px;
      color:var(--muted);
      min-width:44px;
      text-align:right;
    }
    .qty{
      font-weight:700;
      color:var(--accent);
      min-width:70px;
      text-align:right;
    }

    /* icon box (always same size) */
    .icon{
      width:28px;height:28px;
      border-radius:6px;
      background:#0b1224;
      border:1px solid #20304a;
      flex:0 0 28px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .icon img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .iconFallbackDot{
      width:14px;height:14px;border-radius:50%;
      background:#64748b;
      display:block;
    }

    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      white-space:nowrap;
    }
    .btn:hover{background:var(--line);}

    .back{
      display:inline-block;
      margin:0 0 10px 0;
      padding:6px 10px;
      border-radius:8px;
      border:1px solid var(--line);
      background:var(--panel2);
      color:var(--text);
      cursor:pointer;
      font-size:13px;
    }
    .indent{
      margin-left:18px;
      border-left:2px solid #24344f;
      padding-left:10px;
      margin-top:8px;
    }
    .tip{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>

<body>
  <h1>L2 Interlude Craft Calculator</h1>

  <div class="tabs">
    <button class="tab active" id="tabWeapons">Weapons</button>
  </div>

  <input id="search" type="text" placeholder="Search weapon (Arcana / Аркана)"/>

  <div class="meta" id="status">Loading data...</div>

  <div id="viewList"></div>
  <div id="viewDetails" style="display:none;"></div>

<script>
/* ==========================
   0) CSV URLS
   ========================== */
const ITEMS_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv';
const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv';

/* ==========================
   1) Telegram
   ========================== */
try{ window.Telegram?.WebApp?.ready(); } catch(e){}

/* ==========================
   2) DOM
   ========================== */
const elSearch  = document.getElementById('search');
const elStatus  = document.getElementById('status');
const elList    = document.getElementById('viewList');
const elDetails = document.getElementById('viewDetails');
const tabWeapons = document.getElementById('tabWeapons');

/* ==========================
   3) State
   ========================== */
let ITEMS = [];
let RECIPES = [];
const itemsById = new Map();     // id -> item
const recipeMap = new Map();     // item_id -> [{component_id, qty}]
let currentTab = 'weapon';
let currentItemId = null;
const expanded = new Set();      // node keys for expand/collapse

/* ==========================
   4) CSV PARSER (quotes-safe + BOM-safe)
   ========================== */
function parseCSV(text){
  const rows = [];
  let row = [];
  let cell = '';
  let inQuotes = false;

  for (let i=0;i<text.length;i++){
    const c = text[i];
    const n = text[i+1];

    if (c === '"' && inQuotes && n === '"'){ cell += '"'; i++; continue; }
    if (c === '"'){ inQuotes = !inQuotes; continue; }

    if (!inQuotes && c === ','){ row.push(cell); cell=''; continue; }
    if (!inQuotes && (c === '\n' || c === '\r')){
      if (c === '\r' && n === '\n') i++;
      row.push(cell); cell='';
      if (!(row.length===1 && row[0].trim()==='')) rows.push(row);
      row=[];
      continue;
    }
    cell += c;
  }
  if (cell.length || row.length){ row.push(cell); rows.push(row); }

  if (!rows.length) return [];
  const headers = rows[0].map((h, idx) => {
    let s = String(h || '').trim();
    // remove BOM if present in first header
    if (idx === 0) s = s.replace(/^\uFEFF/, '');
    return s;
  });

  return rows.slice(1)
    .filter(r => r.some(x => String(x||'').trim() !== ''))
    .map(r => {
      const obj = {};
      headers.forEach((h,idx) => obj[h] = String(r[idx] ?? '').trim());
      return obj;
    });
}

async function loadCSV(url){
  const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
  const res = await fetch(url + bust, { cache: 'no-store' });
  if (!res.ok) throw new Error('Fetch failed: ' + res.status + ' | ' + url);
  const text = await res.text();
  return parseCSV(text);
}

/* ==========================
   5) Helpers
   ========================== */
function showError(err){
  elStatus.textContent = 'ERROR';
  elList.innerHTML = '';
  const box = document.createElement('div');
  box.className = 'errorBox';
  box.textContent = String(err && (err.stack || err.message) ? (err.stack || err.message) : err);
  elList.appendChild(box);
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

function getCategory(it){
  return String((it.category ?? it.type ?? '')).trim().toLowerCase();
}
function getCraftable(it){
  const v = String(it.craftable ?? '').trim().toLowerCase();
  return (v === 'yes' || v === 'true' || v === '1');
}
function labelItem(it){
  const en = (it.name_en ?? '').trim();
  const ru = (it.name_ru ?? '').trim();
  if (en && ru) return `${en} — ${ru}`;
  return en || ru || '(no name)';
}

/* icon: accept MANY column names */
function getIcon(it){
  const candidates = [
    it.icon,
    it.icon_url,
    it.iconLink,
    it.image,
    it.img,
    it.picture,
    it.pic
  ];
  for (const v of candidates){
    const s = String(v ?? '').trim();
    if (s) return s;
  }
  return '';
}

function iconHTML(it){
  const url = getIcon(it);
  if (!url){
    return `<span class="icon"><span class="iconFallbackDot"></span></span>`;
  }
  // if image blocked/404 -> replace with dot
  return `
    <span class="icon">
      <img src="${escapeHtml(url)}" alt=""
           referrerpolicy="no-referrer"
           onerror="this.remove(); this.parentNode.innerHTML='<span class=\\'iconFallbackDot\\'></span>';">
    </span>`;
}

function hasRecipe(itemId){
  const arr = recipeMap.get(String(itemId));
  return !!(arr && arr.length);
}

/* ==========================
   6) Build indexes
   ========================== */
function buildIndexes(){
  itemsById.clear();
  recipeMap.clear();

  for (const raw of ITEMS){
    const id = String(raw.id ?? '').trim();
    if (!id) continue;

    const it = {
      id,
      name_en: String(raw.name_en ?? '').trim(),
      name_ru: String(raw.name_ru ?? '').trim(),
      category: String(raw.category ?? '').trim(),
      craftable: String(raw.craftable ?? '').trim(),

      // keep ALL possible icon columns (so getIcon sees them)
      icon: String(raw.icon ?? '').trim(),
      icon_url: String(raw.icon_url ?? '').trim(),
      iconLink: String(raw.iconLink ?? '').trim(),
      image: String(raw.image ?? '').trim(),
      img: String(raw.img ?? '').trim(),
      picture: String(raw.picture ?? '').trim(),
      pic: String(raw.pic ?? '').trim()
    };
    itemsById.set(id, it);
  }

  for (const r of RECIPES){
    const itemId = String(r.item_id ?? '').trim();
    const compId = String(r.component_id ?? '').trim();
    const qty = Number(String(r.qty ?? '0').trim()) || 0;
    if (!itemId || !compId || !qty) continue;

    if (!recipeMap.has(itemId)) recipeMap.set(itemId, []);
    recipeMap.get(itemId).push({ component_id: compId, qty });
  }
}

/* ==========================
   7) Tab + List
   ========================== */
function setTab(tab){
  currentTab = tab;
  tabWeapons.classList.toggle('active', tab === 'weapon');
  elSearch.value = '';
  currentItemId = null;
  expanded.clear();
  renderList();
}

function renderList(){
  elDetails.style.display = 'none';
  elList.style.display = 'block';
  elList.innerHTML = '';

  const q = (elSearch.value || '').trim().toLowerCase();

  const filtered = Array.from(itemsById.values()).filter(it => getCategory(it) === currentTab);
  const shown = !q ? filtered : filtered.filter(it => {
    const en = (it.name_en || '').toLowerCase();
    const ru = (it.name_ru || '').toLowerCase();
    return en.includes(q) || ru.includes(q);
  });

  // icon stats
  const iconsFilled = filtered.filter(it => !!getIcon(it)).length;

  if (filtered.length === 0){
    elStatus.textContent = `Weapons: 0\nNo weapons found. Проверь category="weapon" в Items.`;
  } else {
    elStatus.textContent = `Weapons: ${shown.length}\nIcons filled: ${iconsFilled}/${filtered.length}`;
  }

  for (const it of shown){
    const row = document.createElement('div');
    row.className = 'row clickable';
    row.innerHTML = `
      <div class="rowline">
        <div class="left">
          ${iconHTML(it)}
          <div class="title">${escapeHtml(labelItem(it))}</div>
        </div>
        <div class="tag">${escapeHtml(getCategory(it))}</div>
      </div>`;
    row.addEventListener('click', () => openDetails(it.id));
    elList.appendChild(row);
  }

  if (shown.length === 0){
    const hint = document.createElement('div');
    hint.className = 'meta';
    hint.textContent = 'Nothing found.';
    elList.appendChild(hint);
  }
}

elSearch.addEventListener('input', renderList);
tabWeapons.addEventListener('click', () => setTab('weapon'));

/* ==========================
   8) Details + Tree
   ========================== */
function openDetails(itemId){
  currentItemId = String(itemId);
  renderDetails();
}

function renderDetails(){
  const root = itemsById.get(currentItemId);
  if (!root){ showError('Item not found: ' + currentItemId); return; }

  elList.style.display = 'none';
  elDetails.style.display = 'block';

  const comps = recipeMap.get(currentItemId) || [];

  const header = `
    <button class="back" id="btnBack">◀ Back</button>
    <div class="meta">Components: ${escapeHtml(labelItem(root))}</div>
    <div class="row">
      <div class="rowline">
        <div class="left">
          ${iconHTML(root)}
          <div class="title"><b>${escapeHtml(labelItem(root))}</b></div>
        </div>
        <div class="tag">${escapeHtml(getCategory(root))}</div>
      </div>
    </div>
  `;

  const container = document.createElement('div');
  container.innerHTML = header;

  const tree = document.createElement('div');
  tree.className = 'indent';
  container.appendChild(tree);

  if (!comps.length){
    const none = document.createElement('div');
    none.className = 'meta';
    none.textContent = 'No recipe for this item.';
    tree.appendChild(none);
  } else {
    for (const c of comps){
      tree.appendChild(renderNode(c.component_id, c.qty, currentItemId + '>' + c.component_id));
    }
    const tip = document.createElement('div');
    tip.className = 'tip';
    tip.textContent = 'Tip: Click ▶ Expand to раскрыть крафт компонента (qty будет умножаться).';
    tree.appendChild(tip);
  }

  elDetails.innerHTML = '';
  elDetails.appendChild(container);

  document.getElementById('btnBack').addEventListener('click', () => setTab(currentTab));
}

function renderNode(itemId, qty, key){
  const it = itemsById.get(String(itemId));
  const craft = it ? (getCraftable(it) && hasRecipe(it.id)) : false;

  const row = document.createElement('div');
  row.className = 'row';

  const btnHtml = craft
    ? `<button class="btn" data-key="${escapeHtml(key)}">${expanded.has(key) ? '▼ Collapse' : '▶ Expand'}</button>`
    : `<span class="tag">base</span>`;

  row.innerHTML = `
    <div class="rowline">
      <div class="left">
        ${it ? iconHTML(it) : `<span class="icon"><span class="iconFallbackDot"></span></span>`}
        <div class="title">${escapeHtml(it ? labelItem(it) : ('Unknown ID: ' + itemId))}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        ${btnHtml}
        <div class="qty">x${formatQty(qty)}</div>
      </div>
    </div>
  `;

  const childrenWrap = document.createElement('div');
  childrenWrap.className = 'indent';
  childrenWrap.style.display = expanded.has(key) ? 'block' : 'none';
  row.appendChild(childrenWrap);

  if (craft){
    const btn = row.querySelector('button.btn');
    btn.addEventListener('click', () => {
      if (expanded.has(key)) expanded.delete(key);
      else expanded.add(key);
      renderDetails();
    });
  }

  if (craft && expanded.has(key)){
    const children = recipeMap.get(String(itemId)) || [];
    if (!children.length){
      const m = document.createElement('div');
      m.className = 'meta';
      m.textContent = 'No recipe rows for this item.';
      childrenWrap.appendChild(m);
    } else {
      for (const ch of children){
        const childQty = qty * ch.qty;
        const childKey = key + '>' + ch.component_id;
        childrenWrap.appendChild(renderNode(ch.component_id, childQty, childKey));
      }
    }
  }

  return row;
}

function formatQty(n){
  if (Number.isInteger(n)) return String(n);
  return String(Math.round(n * 1000) / 1000);
}

/* ==========================
   9) Init
   ========================== */
async function init(){
  try{
    elStatus.textContent = 'Loading Items...';
    ITEMS = await loadCSV(ITEMS_URL);

    elStatus.textContent = 'Loading Recipes...';
    RECIPES = await loadCSV(RECIPES_URL);

    buildIndexes();

    console.log('ITEMS:', ITEMS);
    console.log('RECIPES:', RECIPES);

    elStatus.textContent = 'Ready';
    setTab('weapon');
  }catch(e){
    console.error(e);
    showError(e);
  }
}

init();
</script>

</body>
</html>
