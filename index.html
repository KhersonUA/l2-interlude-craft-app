<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>L2 Interlude Craft Calculator</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}

header {
  display: flex;
  gap: 6px;
  padding: 10px;
  background: #020617;
}

.tab {
  flex: 1;
  padding: 8px;
  background: #1e293b;
  text-align: center;
  border-radius: 6px;
  cursor: pointer;
}

.tab.active {
  background: #38bdf8;
  color: #020617;
  font-weight: bold;
}

.lang {
  position: absolute;
  right: 10px;
  top: 10px;
  cursor: pointer;
}

.container {
  padding: 10px;
}

.search {
  width: 100%;
  padding: 8px;
  margin-bottom: 10px;
  border-radius: 6px;
  border: none;
}

.item {
  background: #1e293b;
  border-radius: 6px;
  padding: 10px;
  margin-bottom: 8px;
  cursor: pointer;
}

.item-header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.item img {
  width: 32px;
  height: 32px;
}

.recipe {
  margin-top: 10px;
  padding-left: 20px;
}

.row {
  display: flex;
  justify-content: space-between;
  margin: 4px 0;
}

input[type="number"] {
  width: 80px;
  padding: 4px;
  border-radius: 4px;
  border: none;
}

.total {
  margin-top: 10px;
  font-weight: bold;
  color: #38bdf8;
}
</style>
</head>

<body>

<header>
  <div class="tab active" data-tab="all">All</div>
  <div class="tab" data-tab="weapon">Weapons</div>
  <div class="tab" data-tab="armor">Armor</div>
  <div class="tab" data-tab="jewelry">Jewelry</div>
  <div class="tab" data-tab="material">Materials</div>
  <div class="lang" id="langBtn">RU</div>
</header>

<div class="container">
  <input class="search" id="search" placeholder="Search">
  <div id="list"></div>
</div>

<script>
const ITEMS_URL = 'PASTE_ITEMS_CSV_URL';
const RECIPES_URL = 'PASTE_RECIPES_CSV_URL';

let ITEMS = [];
let RECIPES = [];
let LANG = 'en';
let TAB = 'all';

async function loadCSV(url) {
  const r = await fetch(url);
  const t = await r.text();
  const lines = t.trim().split('\n');
  const h = lines[0].split(',');
  return lines.slice(1).map(l => {
    const v = l.split(',');
    const o = {};
    h.forEach((k,i)=>o[k]=v[i]);
    return o;
  });
}

async function loadData() {
  ITEMS = await loadCSV(ITEMS_URL);
  RECIPES = await loadCSV(RECIPES_URL);
  render();
}

function render() {
  const list = document.getElementById('list');
  const q = document.getElementById('search').value.toLowerCase();
  list.innerHTML = '';

  ITEMS.filter(i => {
    if (TAB !== 'all' && i.category !== TAB) return false;
    const name = LANG === 'en' ? i.name_en : i.name_ru;
    return name.toLowerCase().includes(q);
  }).forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';

    const name = LANG === 'en' ? item.name_en : item.name_ru;

    div.innerHTML = `
      <div class="item-header">
        <img src="${item.icon}">
        <b>${name}</b>
      </div>
    `;

    const recipe = RECIPES.filter(r => r.result_id === item.id);
    if (recipe.length) {
      const rdiv = document.createElement('div');
      rdiv.className = 'recipe';

      recipe.forEach(r => {
        const comp = ITEMS.find(x => x.id === r.component_id);
        if (!comp) return;

        const cname = LANG === 'en' ? comp.name_en : comp.name_ru;

        rdiv.innerHTML += `
          <div class="row">
            <span>${cname} x${r.count}</span>
            <input type="number" min="0" value="0" oninput="recalc(this, ${r.count})">
          </div>
        `;
      });

      rdiv.innerHTML += `<div class="total">Total: <span>0</span> Adena</div>`;
      div.appendChild(rdiv);
    }

    list.appendChild(div);
  });
}

function recalc(input, count) {
  const recipe = input.closest('.recipe');
  let total = 0;
  recipe.querySelectorAll('input').forEach(i => {
    total += Number(i.value || 0) * count;
  });
  recipe.querySelector('.total span').textContent = total;
}

document.querySelectorAll('.tab').forEach(t => {
  t.onclick = () => {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    TAB = t.dataset.tab;
    render();
  };
});

document.getElementById('langBtn').onclick = () => {
  LANG = LANG === 'en' ? 'ru' : 'en';
  document.getElementById('langBtn').textContent = LANG.toUpperCase();
  render();
};

document.getElementById('search').oninput = render;

Telegram.WebApp.ready();
loadData();
</script>

</body>
</html>
