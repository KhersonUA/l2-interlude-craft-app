<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L2 Interlude Craft Calculator</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0f172a;
      --panel:#111c33;
      --card:#1e293b;
      --card2:#24344d;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#fbbf24;
      --line:#334155;
      --btn:#0b1223;
      --btn2:#0a1020;
      --ok:#22c55e;
      --bad:#ef4444;
      --chip:#0b1a36;
    }
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
    }
    h1{
      font-size: 18px;
      margin: 0 0 12px 0;
      font-weight: 700;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }

    .btn{
      background: var(--btn);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 8px 10px;
      border-radius: 8px;
      cursor:pointer;
      font-size: 13px;
      user-select:none;
    }
    .btn:hover{ background: var(--btn2); }
    .btn.primary{ border-color: var(--accent); }
    .btn.small{ padding:6px 8px; font-size:12px; }

    .input{
      width: 100%;
      padding: 10px;
      font-size: 14px;
      margin: 8px 0 12px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      outline: none;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .muted{ color: var(--muted); font-size:12px; }

    .list{
      background: transparent;
      border-radius: 10px;
      overflow:hidden;
    }
    .item{
      background: var(--card);
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(255,255,255,0.06);
    }
    .item:hover{ background: var(--card2); }

    .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .ico{
      width:22px;height:22px;
      border-radius:6px;
      background:#0b1223;
      border:1px solid rgba(255,255,255,0.08);
      flex:0 0 auto;
      object-fit:cover;
    }
    .title{
      font-size: 13px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      font-size: 12px;
      color: var(--muted);
    }
    .qty{
      color: var(--accent);
      font-weight:700;
      font-size: 13px;
    }
    .chip{
      background: var(--chip);
      border:1px solid rgba(255,255,255,0.08);
      padding: 3px 8px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
    }

    .panel{
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 12px;
    }

    .tree{
      margin-top: 10px;
    }
    .indent{
      margin-left: 18px;
      border-left: 1px solid rgba(255,255,255,0.08);
      padding-left: 10px;
    }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 12px;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.08);
    }
    .table th, .table td{
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding: 8px 8px;
      font-size: 12px;
      text-align:left;
      vertical-align: middle;
      background: rgba(255,255,255,0.02);
    }
    .table th{
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-weight:700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .table tr:last-child td{ border-bottom:none; }

    .num{
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }
    .num.bad{ color: var(--bad); font-weight:700; }
    .num.ok{ color: var(--ok); font-weight:700; }

    .cell-input{
      width: 90px;
      padding: 6px 6px;
      border-radius: 8px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline:none;
      font-size: 12px;
    }

    .totalbar{
      margin-top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
    }
    .totalbar .big{
      font-size: 14px;
      font-weight: 800;
      color: var(--accent);
    }

    .hidden{ display:none; }
  </style>
</head>

<body>
  <h1>L2 Interlude Craft Calculator</h1>

  <div id="viewList">
    <div class="topbar">
      <button class="btn primary" id="tabWeapons">Weapons</button>
      <span class="muted" id="statusLine">Loading data...</span>
    </div>

    <input class="input" id="searchInput" type="text" placeholder="Search weapon (Arcana / Аркана)" />

    <div class="muted" id="countLine"></div>
    <div class="list" id="weaponsList"></div>
  </div>

  <div id="viewDetails" class="hidden">
    <div class="topbar">
      <button class="btn" id="btnBack">◀ Back</button>
      <div class="muted" id="crumbs"></div>
      <div style="flex:1"></div>
      <button class="btn primary" id="btnGoWeapons">Weapons</button>
    </div>

    <div class="panel">
      <div class="row" style="margin-bottom:10px;">
        <div class="muted">Craft quantity (how many items to craft)</div>
        <input class="cell-input" id="craftQty" inputmode="numeric" autocomplete="off" />
        <button class="btn small" id="btnTree">TREE VIEW</button>
        <button class="btn small primary" id="btnTotal">TOTAL MATERIALS</button>
        <span class="muted" id="iconsStat"></span>
      </div>

      <div id="treeBlock" class="tree"></div>

      <div id="totalBlock" class="hidden">
        <table class="table" id="totalTable">
          <thead>
            <tr>
              <th style="width:34%;">Component</th>
              <th style="width:10%;">Need</th>
              <th style="width:14%;">On hands</th>
              <th style="width:12%;">To buy</th>
              <th style="width:14%;">Price (Adena)</th>
              <th style="width:16%;">Cost (Adena)</th>
            </tr>
          </thead>
          <tbody id="totalTbody"></tbody>
        </table>

        <div class="totalbar">
          <div class="muted" id="totalMeta"></div>
          <div class="big" id="grandTotal">Total: 0 Adena</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /***********************************************************
   * ВАЖНО: ПРОЦЕНТ (100%) / (60%) В РЕЦЕПТЕ ПОЛНОСТЬЮ ИГНОРИРУЕМ.
   * - Никакой "шанс крафта" НЕ используется.
   * - Количество материалов НЕ меняется от процентов.
   * - (100%) удаляем только из отображения (чтобы не мешало).
   ***********************************************************/

  /* ===== CSV LINKS ===== */
  const ITEMS_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv';
  const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv';

  /* ===== TELEGRAM ===== */
  const tg = window.Telegram?.WebApp;
  try { tg?.ready(); } catch(e){}

  /* ===== STATE ===== */
  let ITEMS = [];
  let RECIPES = [];
  let itemsById = new Map();
  let childrenByItemId = new Map(); // item_id -> [{component_id, qty}]
  let currentRootId = null;

  // User inputs (persist in localStorage)
  const LS_KEY = 'l2_craft_inputs_v1';
  let userInputs = {
    have: {},  // id -> number
    price: {}  // id -> number
  };

  // icons stats
  let iconsTotal = 0, iconsOk = 0;

  /* ===== HELPERS ===== */
  function parseCSVLine(line){
    // минимальный CSV парсер (поддержка кавычек)
    const out = [];
    let cur = '';
    let inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ){
        out.push(cur);
        cur = '';
      } else {
        cur += ch;
      }
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  async function loadCSV(url){
    const res = await fetch(url, { cache:'no-store' });
    const text = await res.text();
    const lines = text.replace(/\r/g,'').trim().split('\n');
    const headers = parseCSVLine(lines[0]);
    return lines.slice(1).filter(Boolean).map(line=>{
      const values = parseCSVLine(line);
      const obj = {};
      headers.forEach((h,i)=> obj[h] = (values[i] ?? ''));
      return obj;
    });
  }

  function toInt(x, def=0){
    const n = parseInt(String(x).replace(/[^\d-]/g,''),10);
    return Number.isFinite(n) ? n : def;
  }

  function toNum(x, def=0){
    const s = String(x ?? '').replace(/\s/g,'').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : def;
  }

  function cleanPercentInName(s){
    // УБИРАЕМ (100%) / (60%) и т.п. ТОЛЬКО В ВЫВОДЕ.
    return String(s ?? '').replace(/\s*\(\s*\d+\s*%\s*\)\s*/g, ' ').replace(/\s+/g,' ').trim();
  }

  function itemLabel(item){
    const en = cleanPercentInName(item.name_en || '');
    const ru = cleanPercentInName(item.name_ru || '');
    if (en && ru) return `${en} — ${ru}`;
    return en || ru || `#${item.id}`;
  }

  function saveInputs(){
    localStorage.setItem(LS_KEY, JSON.stringify(userInputs));
  }

  function loadInputs(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const obj = JSON.parse(raw);
      if (obj && typeof obj === 'object'){
        userInputs.have = obj.have || {};
        userInputs.price = obj.price || {};
      }
    } catch(e){}
  }

  function getHave(id){ return toInt(userInputs.have[id] ?? 0, 0); }
  function getPrice(id){ return toNum(userInputs.price[id] ?? 0, 0); }

  function setHave(id, v){ userInputs.have[id] = Math.max(0, toInt(v,0)); saveInputs(); }
  function setPrice(id, v){ userInputs.price[id] = Math.max(0, toNum(v,0)); saveInputs(); }

  function makeImg(src){
    const img = document.createElement('img');
    img.className = 'ico';
    img.alt = '';
    img.loading = 'lazy';
    img.decoding = 'async';
    img.src = src || '';
    img.onerror = ()=>{ img.style.visibility='hidden'; };
    return img;
  }

  function iconsRecalc(){
    iconsTotal = 0; iconsOk = 0;
    for (const it of ITEMS){
      if (it.icon){
        iconsTotal++;
      }
    }
    // Для "ok" проверяем загрузку не можем синхронно, поэтому считаем "заполнено"
    // как наличие URL иконки.
    iconsOk = iconsTotal;
    const el = document.getElementById('iconsStat');
    if (el){
      el.textContent = `Icons filled: ${iconsOk}/${iconsTotal}`;
    }
  }

  function buildIndex(){
    itemsById = new Map();
    childrenByItemId = new Map();

    for (const it of ITEMS){
      const id = toInt(it.id);
      it.id = id;
      it.category = String(it.category || '').trim().toLowerCase();
      it.craftable = String(it.craftable || '').trim().toLowerCase(); // yes/no
      it.icon = String(it.icon || '').trim();
      itemsById.set(id, it);
    }

    for (const r of RECIPES){
      const item_id = toInt(r.item_id);
      const component_id = toInt(r.component_id);
      const qty = toInt(r.qty);
      if (!childrenByItemId.has(item_id)) childrenByItemId.set(item_id, []);
      childrenByItemId.get(item_id).push({ component_id, qty });
    }

    iconsRecalc();
  }

  function getChildren(itemId){
    return childrenByItemId.get(itemId) || [];
  }

  /* ===== CALC ===== */
  // ВАЖНО: никаких процентов/шансов — только чистая математика qty * craftQty.
  function aggregateTotals(rootId, craftQty){
    const totals = new Map(); // id -> qty
    const visitedStack = new Set(); // detect cycles

    function walk(id, mult){
      if (visitedStack.has(id)) return; // защита от циклов
      visitedStack.add(id);

      const kids = getChildren(id);
      for (const k of kids){
        const need = k.qty * mult;
        totals.set(k.component_id, (totals.get(k.component_id) || 0) + need);

        const comp = itemsById.get(k.component_id);
        if (comp && comp.craftable === 'yes' && getChildren(k.component_id).length){
          // раскрываем вложенный крафт
          walk(k.component_id, need);
        }
      }

      visitedStack.delete(id);
    }

    walk(rootId, craftQty);
    return totals; // материалы + крафтабельные промежутки тоже будут учтены как позиции
  }

  function renderTree(rootId, craftQty){
    const root = itemsById.get(rootId);
    const tree = document.getElementById('treeBlock');
    tree.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'muted';
    header.textContent = `Components: ${itemLabel(root)} (x${craftQty})`;
    tree.appendChild(header);

    const container = document.createElement('div');
    container.style.marginTop = '10px';
    tree.appendChild(container);

    function nodeRow(item, qty, level, isExpandable, expanded){
      const row = document.createElement('div');
      row.className = 'item';
      row.style.marginLeft = (level*14) + 'px';

      const left = document.createElement('div');
      left.className = 'left';

      const img = makeImg(item.icon);
      left.appendChild(img);

      const t = document.createElement('div');
      t.className = 'title';
      t.textContent = itemLabel(item);
      left.appendChild(t);

      const right = document.createElement('div');
      right.className = 'right';

      const cat = document.createElement('span');
      cat.className = 'chip';
      cat.textContent = item.category || '';
      right.appendChild(cat);

      if (isExpandable){
        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.textContent = expanded ? 'Collapse' : 'Expand';
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          item.__expanded = !item.__expanded;
          renderTree(rootId, toInt(document.getElementById('craftQty').value,1));
        });
        right.appendChild(btn);
      } else {
        const base = document.createElement('span');
        base.className = 'muted';
        base.textContent = 'base';
        right.appendChild(base);
      }

      const q = document.createElement('span');
      q.className = 'qty';
      q.textContent = `x${qty}`;
      right.appendChild(q);

      row.appendChild(left);
      row.appendChild(right);
      return row;
    }

    function renderChildren(parentId, mult, level){
      const kids = getChildren(parentId);
      for (const k of kids){
        const it = itemsById.get(k.component_id);
        if (!it) continue;

        const qty = k.qty * mult;
        const canExpand = (it.craftable === 'yes' && getChildren(it.id).length > 0);
        const expanded = !!it.__expanded;

        const row = nodeRow(it, qty, level, canExpand, expanded);
        container.appendChild(row);

        if (canExpand && expanded){
          renderChildren(it.id, qty, level+1);
        }
      }
    }

    renderChildren(rootId, craftQty, 0);

    const tip = document.createElement('div');
    tip.className = 'muted';
    tip.style.marginTop = '8px';
    tip.textContent = 'Tip: Click Expand to раскрыть крафт компонента (qty будет умножаться).';
    tree.appendChild(tip);
  }

  function renderTotals(rootId, craftQty){
    const totals = aggregateTotals(rootId, craftQty);
    const tbody = document.getElementById('totalTbody');
    tbody.innerHTML = '';

    // сортировка: сначала weapon/material по названию
    const rows = Array.from(totals.entries()).map(([id, need])=>{
      const it = itemsById.get(id);
      return { id, need, it };
    }).filter(r => r.it);

    rows.sort((a,b)=>{
      const ca = (a.it.category || '').localeCompare(b.it.category || '');
      if (ca !== 0) return ca;
      return itemLabel(a.it).localeCompare(itemLabel(b.it));
    });

    let grand = 0;

    for (const r of rows){
      const have = getHave(r.id);
      const toBuy = Math.max(0, r.need - have);
      const price = getPrice(r.id);
      const cost = toBuy * price;
      grand += cost;

      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      const wrap = document.createElement('div');
      wrap.className = 'left';

      wrap.appendChild(makeImg(r.it.icon));

      const txt = document.createElement('div');
      txt.className = 'title';
      txt.textContent = itemLabel(r.it);
      wrap.appendChild(txt);

      tdName.appendChild(wrap);

      const tdNeed = document.createElement('td');
      tdNeed.className = 'num';
      tdNeed.textContent = r.need;

      const tdHave = document.createElement('td');
      const inpHave = document.createElement('input');
      inpHave.className = 'cell-input';
      inpHave.inputMode = 'numeric';
      inpHave.value = String(have);
      inpHave.addEventListener('input', ()=>{
        // разрешаем много цифр, чистим только не-цифры
        inpHave.value = inpHave.value.replace(/[^\d]/g,'');
        setHave(r.id, inpHave.value);
        renderTotals(rootId, toInt(document.getElementById('craftQty').value,1));
      });
      tdHave.appendChild(inpHave);

      const tdDiff = document.createElement('td');
      tdDiff.className = 'num ' + (toBuy>0 ? 'bad' : 'ok');
      tdDiff.textContent = toBuy;

      const tdPrice = document.createElement('td');
      const inpPrice = document.createElement('input');
      inpPrice.className = 'cell-input';
      inpPrice.inputMode = 'decimal';
      inpPrice.value = String(price || '');
      inpPrice.placeholder = '0';
      inpPrice.addEventListener('input', ()=>{
        // разрешаем число с точкой/запятой
        inpPrice.value = inpPrice.value.replace(/[^0-9.,]/g,'');
        setPrice(r.id, inpPrice.value);
        renderTotals(rootId, toInt(document.getElementById('craftQty').value,1));
      });
      tdPrice.appendChild(inpPrice);

      const tdCost = document.createElement('td');
      tdCost.className = 'num';
      tdCost.textContent = cost.toLocaleString('en-US');

      tr.appendChild(tdName);
      tr.appendChild(tdNeed);
      tr.appendChild(tdHave);
      tr.appendChild(tdDiff);
      tr.appendChild(tdPrice);
      tr.appendChild(tdCost);

      tbody.appendChild(tr);
    }

    document.getElementById('grandTotal').textContent =
      `Total: ${grand.toLocaleString('en-US')} Adena`;

    const root = itemsById.get(rootId);
    document.getElementById('totalMeta').textContent =
      `${itemLabel(root)} (x${craftQty}) — total lines: ${rows.length}`;
  }

  /* ===== UI ===== */
  function showList(){
    document.getElementById('viewList').classList.remove('hidden');
    document.getElementById('viewDetails').classList.add('hidden');
  }
  function showDetails(rootId){
    currentRootId = rootId;
    document.getElementById('viewList').classList.add('hidden');
    document.getElementById('viewDetails').classList.remove('hidden');

    const root = itemsById.get(rootId);
    document.getElementById('crumbs').textContent = `Components: ${itemLabel(root)} (x1)`;

    const qtyEl = document.getElementById('craftQty');
    qtyEl.value = '1';

    renderTree(rootId, 1);
    renderTotals(rootId, 1);

    document.getElementById('treeBlock').classList.remove('hidden');
    document.getElementById('totalBlock').classList.add('hidden');
  }

  function renderWeaponsList(){
    const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
    const list = document.getElementById('weaponsList');
    list.innerHTML = '';

    const weapons = ITEMS.filter(it => it.category === 'weapon');

    const filtered = weapons.filter(it=>{
      const a = `${it.name_en||''} ${it.name_ru||''}`.toLowerCase();
      return !q || a.includes(q);
    });

    document.getElementById('countLine').textContent = `Weapons: ${filtered.length}`;

    for (const it of filtered){
      const row = document.createElement('div');
      row.className = 'item';

      const left = document.createElement('div');
      left.className = 'left';
      left.appendChild(makeImg(it.icon));
      const t = document.createElement('div');
      t.className = 'title';
      t.textContent = itemLabel(it);
      left.appendChild(t);

      const right = document.createElement('div');
      right.className = 'right';
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = it.category;
      right.appendChild(chip);

      row.appendChild(left);
      row.appendChild(right);

      row.addEventListener('click', ()=> showDetails(it.id));
      list.appendChild(row);
    }
  }

  function wireUI(){
    document.getElementById('tabWeapons').addEventListener('click', ()=>{
      showList();
      renderWeaponsList();
    });

    document.getElementById('btnBack').addEventListener('click', ()=>{
      showList();
      renderWeaponsList();
    });

    document.getElementById('btnGoWeapons').addEventListener('click', ()=>{
      showList();
      renderWeaponsList();
    });

    document.getElementById('searchInput').addEventListener('input', ()=>{
      renderWeaponsList();
    });

    document.getElementById('btnTree').addEventListener('click', ()=>{
      document.getElementById('treeBlock').classList.remove('hidden');
      document.getElementById('totalBlock').classList.add('hidden');
    });

    document.getElementById('btnTotal').addEventListener('click', ()=>{
      document.getElementById('treeBlock').classList.add('hidden');
      document.getElementById('totalBlock').classList.remove('hidden');
      if (currentRootId){
        renderTotals(currentRootId, toInt(document.getElementById('craftQty').value,1));
      }
    });

    const qtyEl = document.getElementById('craftQty');
    qtyEl.addEventListener('input', ()=>{
      // разрешаем много цифр
      qtyEl.value = qtyEl.value.replace(/[^\d]/g,'');
      const v = Math.max(1, toInt(qtyEl.value, 1));
      qtyEl.value = String(v);

      if (!currentRootId) return;
      document.getElementById('crumbs').textContent =
        `Components: ${itemLabel(itemsById.get(currentRootId))} (x${v})`;

      renderTree(currentRootId, v);
      renderTotals(currentRootId, v);
    });
  }

  /* ===== LOAD ===== */
  async function init(){
    loadInputs();
    wireUI();

    try{
      document.getElementById('statusLine').textContent = 'Loading data...';
      ITEMS = await loadCSV(ITEMS_URL);
      RECIPES = await loadCSV(RECIPES_URL);

      // нормализуем ключи для RECIPES (если вдруг у тебя headers иначе)
      // ожидаем: item_id, component_id, qty
      // если в таблице другие заголовки — приведи их к этим трём.
      buildIndex();

      document.getElementById('statusLine').textContent =
        `Loaded: items ${ITEMS.length}, recipes ${RECIPES.length}`;

      showList();
      renderWeaponsList();

    } catch(e){
      console.error(e);
      document.getElementById('statusLine').textContent = 'Load error. Check CSV publish & headers.';
    }
  }

  init();
  </script>
</body>
</html>
