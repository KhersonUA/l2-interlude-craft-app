<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>L2 Interlude Craft Calculator</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#f59e0b;
      --border:#2b3a57;
      --good:#22c55e;
      --bad:#ef4444;
    }
    body{
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      padding:16px;
    }
    h1{ font-size:18px; margin:0; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .top-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .btn{
      background:#0b1a33;
      color:var(--text);
      border:1px solid #36507a;
      padding:6px 10px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ background:#122546; }
    .btn.active{
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(245,158,11,.25) inset;
    }

    /* Mobile-friendly horizontal scroller for filters/subtabs */
    .hscroll{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:2px;
      margin-top:10px;
    }
    .hscroll::-webkit-scrollbar{ height:6px; }
    .hscroll::-webkit-scrollbar-thumb{ background:#1f2f4e; border-radius:999px; }

    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin:10px 0 12px 0;
      flex-wrap:wrap;
    }
    .toolbar label{
      font-size:12px;
      color:var(--muted);
    }

    input[type="text"], input[type="number"]{
      width:100%;
      padding:10px;
      font-size:16px;
      margin:0;
      border-radius:6px;
      border:1px solid var(--border);
      background: #0b1630;
      color: var(--text);
      outline:none;
    }
    input[type="number"]{
      width:90px;
      padding:8px;
      font-size:14px;
    }

    .hint{ font-size:12px; color:var(--muted); margin-top:6px; }

    .list{ margin-top:10px; }
    .item-row{
      background: #13203a;
      border:1px solid #223455;
      padding:10px;
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .item-row:hover{ background:#17284a; }
    .item-left{ display:flex; align-items:center; gap:10px; min-width:0; }
    .name{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 900px;
      font-size:14px;
    }
    .badge{
      font-size:11px;
      color:var(--muted);
      border:1px solid var(--border);
      padding:2px 6px;
      border-radius:999px;
      text-transform:lowercase;
    }
    .qty{ font-weight:bold; color: var(--accent); margin-left:10px; white-space:nowrap; }

    .icon{
      width:22px;
      height:22px;
      border-radius:6px;
      object-fit:cover;
      flex:0 0 auto;
      background: #0b1630;
      border:1px solid var(--border);
    }
    .dot{
      width:12px;
      height:12px;
      border-radius:999px;
      background:#334155;
      border:1px solid #475569;
      flex:0 0 auto;
    }

    .details-header{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .title-small{ font-size:13px; color:var(--muted); }

    .tree, .total{ margin-top:10px; }

    .node{
      border:1px solid var(--border);
      background: #12223f;
      border-radius:10px;
      margin:10px 0;
      overflow:hidden;
    }
    .node-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      background: #132646;
    }
    .node-children{
      padding:8px 10px 12px 22px;
      border-top:1px solid var(--border);
      display:none;
    }
    .node.open > .node-children{ display:block; }

    .small{ font-size:12px; color: var(--muted); }
    .right{ display:flex; align-items:center; gap:12px; white-space:nowrap; }
    .expand-btn{
      padding:4px 8px;
      font-size:12px;
      border-radius:8px;
      border:1px solid #36507a;
      background:#0b1a33;
      color:var(--text);
      cursor:pointer;
    }
    .expand-btn:hover{ background:#122546; }

    /* Tier badge (Weapons list only) */
    .badge-tier{
      font-size:11px;
      color:var(--text);
      border:1px solid var(--border);
      padding:2px 8px;
      border-radius:999px;
      text-transform:uppercase;
      font-weight:700;
      letter-spacing:.2px;
      opacity:.95;
    }
    .badge-tier.c{
      background: rgba(34,197,94,.18);   /* green */
      border-color: rgba(34,197,94,.55);
      color: #bbf7d0;
    }
    .badge-tier.b{
      background: rgba(239,68,68,.18);   /* red */
      border-color: rgba(239,68,68,.55);
      color: #fecaca;
    }
    .badge-tier.a{
      background: rgba(59,130,246,.18);  /* blue */
      border-color: rgba(59,130,246,.55);
      color: #bfdbfe;
    }
    .badge-tier.s{
      background: rgba(210,180,140,.22); /* light brown */
      border-color: rgba(210,180,140,.55);
      color: #f5deb3;
    }
    .badge-tier.s80{
      background: rgba(101,67,33,.28);   /* dark brown */
      border-color: rgba(101,67,33,.60);
      color: #e7d3b3;
    }
    .badge-tier.s84{
      background: rgba(245,158,11,.22);  /* gold */
      border-color: rgba(245,158,11,.65);
      color: #fde68a;
    }

    .subtab-icon{ margin-right:6px; opacity:.85; }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      border:1px solid var(--border);
      overflow:hidden;
      border-radius:10px;
    }
    thead th{
      background:#132646;
      color:var(--muted);
      font-size:12px;
      text-align:left;
      padding:10px;
      border-bottom:1px solid var(--border);
    }
    tbody td, tfoot td{
      padding:10px;
      border-bottom:1px solid #1f2f4e;
      vertical-align:middle;
      font-size:13px;
    }
    tbody tr:hover{ background:#12223f; }

    .cell-name{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .cell-name span{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .num{
      text-align:right;
      font-variant-numeric: tabular-nums;
    }
    .pos{ color: var(--good); font-weight:700; }
    .neg{ color: var(--bad); font-weight:700; }

    .summary{
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:10px;
      background:#0f1c36;
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      align-items:center;
    }
    .summary .k{ font-size:12px; color:var(--muted); }
    .summary .v{ font-size:14px; font-weight:700; }

    .tfoot{
      background:#0f1c36;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbar-left">
      <h1>L2 Interlude Craft Calculator</h1>
      <div class="top-tabs">
        <button id="tabWeapons" class="btn active">Weapons</button>
        <button id="tabArmors" class="btn">Armors</button>
        <button id="tabJewelry" class="btn">Jewelry</button>
        <button id="tabMaterials" class="btn">Materials</button>
      </div>
    </div>

    <div class="topbar-right">
      <button id="btnLang" class="btn">EN</button>
    </div>
  </div>

  <!-- LIST SCREEN -->
  <div id="screenList">
    <input id="searchInput" type="text" placeholder="Search item" />

    <!-- Subtype subtabs (Weapons/Armors/Jewelry only) -->
    <div id="subtypeFilter" class="hscroll" style="display:none;"></div>

    <!-- Tier filter (only for Weapons) -->
    <div id="tierFilter" class="hscroll" style="display:none;">
      <button class="btn active" data-tier="all">ALL</button>
      <button class="btn" data-tier="C">C</button>
      <button class="btn" data-tier="B">B</button>
      <button class="btn" data-tier="A">A</button>
      <button class="btn" data-tier="S">S</button>
      <button class="btn" data-tier="S80">S80</button>
      <button class="btn" data-tier="S84">S84</button>
    </div>

    <div class="hint" id="statusLine">Loading data...</div>
    <div class="list" id="itemsList"></div>
  </div>

  <!-- DETAILS SCREEN -->
  <div id="screenDetails" style="display:none;">
    <div class="details-header">
      <button id="btnBack" class="btn">‚óÄ Back</button>
      <div class="title-small" id="detailsTitle">Components</div>
    </div>

    <div class="toolbar">
      <label id="lblCraftQty">Craft quantity</label>
      <input id="craftQty" type="number" min="1" step="1" value="1"/>
      <button id="btnTree" class="btn active">TREE VIEW</button>
      <button id="btnTotal" class="btn">TOTAL MATERIALS</button>
      <button id="btnReset" class="btn">Reset have/price</button>
      <div class="small" id="iconsInfo"></div>
    </div>

    <div id="treeView" class="tree"></div>

    <div id="totalView" class="total" style="display:none;">
      <div class="summary" id="costSummary"></div>
      <div id="totalTableWrap"></div>
    </div>
  </div>

  <script>
    // ======== DATA SOURCES (your links) ========
    const URLS = {
      weapon: {
        items:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv',
        recipes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv'
      },
      armor: {
        items:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1627511129&single=true&output=csv',
        recipes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=523225506&single=true&output=csv'
      },
      jewelry: {
        items:   'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=923026496&single=true&output=csv',
        recipes: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=2033866316&single=true&output=csv'
      }
    };

    // ======== SUBTABS (values must match your Items column "subtype" - case-insensitive) ========
    // Weapons: Fists only (Fist/First removed)
    // Armor: Shield before Sigils (as requested)
    const SUBTABS = {
      weapon: [
        'Daggers',
        'One handed swords',
        'Two handed swords',
        'Bows',
        'One handed blunts',
        'Two handed blunts',
        'Spears',
        'Fists',
        'One handed magic',
        'Two Handed magic',
        'Dual Sword'
      ],
      armor: [
        'Heavy Armor',
        'Light Armor',
        'Magic Armor',
        'Gloves',
        'Boots',
        'Helmet',
        'Shield',
        'Sigils'
      ],
      jewelry: [
        'Necklaces',
        'Earrings',
        'Rings'
      ]
    };

    // Short UI labels (UI only; filtering uses original subtype text)
    const SUBTYPE_SHORT = {
      'One handed swords': '1H Swords',
      'Two handed swords': '2H Swords',
      'One handed blunts': '1H Blunts',
      'Two handed blunts': '2H Blunts',
      'One handed magic': '1H Magic',
      'Two Handed magic': '2H Magic',
      'Dual Sword': 'Dual Swords'
    };

    // Subtype icons (emoji; Telegram-safe, no external CDN)
    const SUBTYPE_ICON = {
      'Daggers':'üó°Ô∏è',
      'One handed swords':'‚öîÔ∏è',
      'Two handed swords':'‚öîÔ∏è',
      'Bows':'üèπ',
      'One handed blunts':'üî®',
      'Two handed blunts':'üî®',
      'Spears':'üî±',
      'Fists':'ü•ä',
      'One handed magic':'üîÆ',
      'Two Handed magic':'üìú',
      'Dual Sword':'‚öîÔ∏è',

      'Heavy Armor':'üõ°Ô∏è',
      'Light Armor':'ü•ã',
      'Magic Armor':'üß•',
      'Gloves':'üß§',
      'Boots':'üë¢',
      'Helmet':'ü™ñ',
      'Shield':'üõ°Ô∏è',
      'Sigils':'‚ú®',

      'Necklaces':'üìø',
      'Earrings':'üíé',
      'Rings':'üíç'
    };

    const TIER_ORDER = { C:20, B:30, A:40, S:50, S80:60, S84:70 };

    // ======== RUNTIME DATA (current active view) ========
    let ITEMS = [];
    let RECIPES = [];
    const itemsById = new Map();
    const recipeByItemId = new Map();

    // cache per category
    const CACHE = {
      items: new Map(),    // weapon|armor|jewelry -> items[]
      recipes: new Map(),  // weapon|armor|jewelry -> recipes[]
      allItems: null,      // merged all items (weap+armor+jew)
      allRecipes: null     // merged all recipes
    };

    // tabs: weapon | armor | jewelry | materials
    let activeCategory = 'weapon';
    let currentItemId = null;

    // modes: tree | total
    let currentMode = 'tree';

    // filters
    let activeTierFilter = 'all';     // all | C | B | A | S | S80 | S84
    let activeSubtypeFilter = 'all';  // all | <subtab string>

    let iconFilled = 0, iconTotal = 0;

    // user data
    let HAVE = {};
    let PRICE = {};
    const LS_HAVE = 'l2_have_v1';
    const LS_PRICE = 'l2_price_v1';

    // language: 'en' | 'ru'
    let LANG = 'en';
    const LS_LANG = 'l2_lang_v1';

    const T = {
      en: {
        tabs: { weapon:'Weapons', armor:'Armors', jewelry:'Jewelry', materials:'Materials' },
        back: '‚óÄ Back',
        searchPlaceholder: 'Search item',
        loading: 'Loading data...',
        itemsCount: (n)=>`Items: ${n}`,
        icons: (f,t)=>`Icons: ${f}/${t}`,
        components: (name, qty)=>`Components: ${name} (x${qty})`,
        totalMaterialsTitle: (name, qty)=>`Total materials: ${name} (x${qty})`,
        craftQty: 'Craft quantity',
        treeView: 'TREE VIEW',
        totalMaterials: 'TOTAL MATERIALS',
        reset: 'Reset have/price',
        noRecipe: 'No recipe found for this item.',
        badgeBase: 'base',
        badgeCraft: 'craft',
        expand: 'Expand',
        collapse: 'Collapse',
        summaryCraftQty: 'Craft qty',
        summaryTotalCost: 'Total cost',
        thMaterial: 'Material',
        thRequired: 'Required',
        thHave: 'Have',
        thNeed: 'Need',
        thPrice: 'Price (1)',
        thCost: 'Cost',
        footTotalCost: 'TOTAL COST (ADENA)',
        langBtn: 'RU',
        all: 'ALL'
      },
      ru: {
        tabs: { weapon:'–û—Ä—É–∂–∏–µ', armor:'–ë—Ä–æ–Ω—è', jewelry:'–ë–∏–∂—É—Ç–µ—Ä–∏—è', materials:'–ú–∞—Ç–µ—Ä–∏–∞–ª—ã' },
        back: '‚óÄ –ù–∞–∑–∞–¥',
        searchPlaceholder: '–ü–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–∞',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...',
        itemsCount: (n)=>`–ü—Ä–µ–¥–º–µ—Ç—ã: ${n}`,
        icons: (f,t)=>`–ò–∫–æ–Ω–∫–∏: ${f}/${t}`,
        components: (name, qty)=>`–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: ${name} (x${qty})`,
        totalMaterialsTitle: (name, qty)=>`–ò—Ç–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã: ${name} (x${qty})`,
        craftQty: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∞—Ñ—Ç–∞',
        treeView: 'TREE VIEW',
        totalMaterials: '–ò–¢–û–ì–û –ú–ê–¢–ï–†–ò–ê–õ–´',
        reset: '–°–±—Ä–æ—Å have/price',
        noRecipe: '–†–µ—Ü–µ–ø—Ç –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.',
        badgeBase: '–±–∞–∑–∞',
        badgeCraft: '–∫—Ä–∞—Ñ—Ç',
        expand: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å',
        collapse: '–°–≤–µ—Ä–Ω—É—Ç—å',
        summaryCraftQty: '–ö–æ–ª-–≤–æ –∫—Ä–∞—Ñ—Ç–∞',
        summaryTotalCost: '–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å',
        thMaterial: '–ú–∞—Ç–µ—Ä–∏–∞–ª',
        thRequired: '–ù—É–∂–Ω–æ',
        thHave: '–ï—Å—Ç—å',
        thNeed: '–ö—É–ø–∏—Ç—å',
        thPrice: '–¶–µ–Ω–∞ (1)',
        thCost: '–°—Ç–æ–∏–º–æ—Å—Ç—å',
        footTotalCost: '–ò–¢–û–ì–û (–ê–î–ï–ù–ê)',
        langBtn: 'EN',
        all: 'ALL'
      }
    };

    function tr(key, ...args){
      const v = T[LANG][key];
      return (typeof v === 'function') ? v(...args) : v;
    }
    function trTab(cat){ return T[LANG].tabs[cat]; }

    function applyI18nStatic(){
      document.getElementById('tabWeapons').textContent   = trTab('weapon');
      document.getElementById('tabArmors').textContent    = trTab('armor');
      document.getElementById('tabJewelry').textContent   = trTab('jewelry');
      document.getElementById('tabMaterials').textContent = trTab('materials');

      document.getElementById('btnBack').textContent = tr('back');
      document.getElementById('searchInput').placeholder = tr('searchPlaceholder');

      document.getElementById('lblCraftQty').textContent = tr('craftQty');
      document.getElementById('btnTree').textContent = tr('treeView');
      document.getElementById('btnTotal').textContent = tr('totalMaterials');
      document.getElementById('btnReset').textContent = tr('reset');

      document.getElementById('btnLang').textContent = tr('langBtn');

      renderSubtypeFilter();
      // tier labels update on next renderItemsList()
    }

    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;

      for (let i=0; i<text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQuotes = !inQuotes; continue; }

        if (ch === ',' && !inQuotes){ row.push(cur); cur=''; continue; }

        if ((ch === '\n' || ch === '\r') && !inQuotes){
          if (ch === '\r' && next === '\n') i++;
          row.push(cur); cur='';
          if (row.length > 1 || row[0] !== '') rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length){ row.push(cur); rows.push(row); }
      return rows;
    }

    async function loadCSV(url){
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('CSV fetch failed: ' + res.status + ' ' + url);
      const text = await res.text();
      const rows = parseCSV(text.trim());
      const headers = rows[0].map(h => h.trim());
      return rows.slice(1).map(cols => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = (cols[i] ?? '').trim());
        return obj;
      });
    }

    function normalizeItems(items){
      items.forEach(it => {
        it.id = String(it.id || '').trim();
        it.category = String(it.category || '').trim().toLowerCase();
        it.craftable = String(it.craftable || '').trim();
        it.icon = String(it.icon || '').trim();
        it.name_en = String(it.name_en || '').trim();
        it.name_ru = String(it.name_ru || '').trim();
        it.tier = String(it.tier || '').trim();        // NEW column
        it.subtype = String(it.subtype || '').trim();  // NEW column
      });
      return items.filter(it => it.id);
    }
    function normalizeRecipes(recipes){
      recipes.forEach(r => {
        r.item_id = String(r.item_id || '').trim();
        r.component_id = String(r.component_id || '').trim();
        r.qty = String(r.qty || '').trim();
      });
      return recipes.filter(r => r.item_id && r.component_id);
    }

    function loadUserData(){
      try{ HAVE = JSON.parse(localStorage.getItem(LS_HAVE) || '{}') || {}; } catch { HAVE = {}; }
      try{ PRICE = JSON.parse(localStorage.getItem(LS_PRICE) || '{}') || {}; } catch { PRICE = {}; }
      try{
        const saved = String(localStorage.getItem(LS_LANG) || '').toLowerCase();
        if (saved === 'ru' || saved === 'en') LANG = saved;
      } catch {}
    }
    function saveHave(){ localStorage.setItem(LS_HAVE, JSON.stringify(HAVE)); }
    function savePrice(){ localStorage.setItem(LS_PRICE, JSON.stringify(PRICE)); }
    function saveLang(){ localStorage.setItem(LS_LANG, LANG); }

    function rebuildIndexes(){
      itemsById.clear();
      recipeByItemId.clear();
      iconFilled = 0; iconTotal = 0;

      for (const it of ITEMS){
        const id = String(it.id);
        itemsById.set(id, it);
        if (it.icon && String(it.icon).trim().length > 0) iconFilled++;
        iconTotal++;
      }

      for (const r of RECIPES){
        const itemId = String(r.item_id);
        const compId = String(r.component_id);
        const qty = Number(r.qty || 0);
        if (!recipeByItemId.has(itemId)) recipeByItemId.set(itemId, []);
        recipeByItemId.get(itemId).push({ component_id: compId, qty });
      }
    }

    function getDisplayName(it){
      if (!it) return 'Unknown';
      const en = (it.name_en || '').trim();
      const ru = (it.name_ru || '').trim();
      if (LANG === 'ru'){
        return ru || en || 'Unnamed';
      } else {
        return en || ru || 'Unnamed';
      }
    }

    function getDisplayNameBoth(it){
      if (!it) return 'Unknown';
      const en = (it.name_en || '').trim();
      const ru = (it.name_ru || '').trim();
      if (en && ru) return `${en} ‚Äî ${ru}`;
      return en || ru || 'Unnamed';
    }

    function iconOrDot(it){
      const icon = (it && it.icon) ? String(it.icon).trim() : '';
      if (icon) return `<img class="icon" src="${icon}" alt="">`;
      return `<span class="dot"></span>`;
    }

    function isCraftable(it){
      return String(it?.craftable || '').toLowerCase() === 'yes';
    }

    function setIconsInfo(){
      document.getElementById('iconsInfo').textContent = tr('icons', iconFilled, iconTotal);
    }

    function showList(){
      document.getElementById('screenDetails').style.display = 'none';
      document.getElementById('screenList').style.display = 'block';
      currentItemId = null;
    }

    function showDetails(){
      document.getElementById('screenList').style.display = 'none';
      document.getElementById('screenDetails').style.display = 'block';
    }

    function toNonNegInt(s){
      const cleaned = String(s || '').replace(/[^\d]/g,'');
      const n = Number(cleaned || 0);
      return Math.max(0, Math.floor(n));
    }

    function formatAdena(n){
      const x = Math.floor(Number(n || 0));
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // ======== Tier sorting for Weapons ========
    function tierRank(it){
      const t = String(it?.tier || '').trim().toUpperCase();
      return TIER_ORDER[t] ?? 999;
    }
    function itemSort(a, b){
      if (activeCategory === 'weapon'){
        const ra = tierRank(a);
        const rb = tierRank(b);
        if (ra !== rb) return ra - rb; // C -> ... -> S84
      }
      return getDisplayName(a).localeCompare(getDisplayName(b));
    }

    // ======== Normalization helpers for subtype matching (forgiving) ========
    function normKey(s){
      return String(s || '')
        .toLowerCase()
        .replace(/\s+/g,' ')
        .trim();
    }

    function subtypeLabel(s){
      return SUBTYPE_SHORT[s] || s;
    }
    function subtypeIcon(s){
      return SUBTYPE_ICON[s] || '‚Ä¢';
    }

    // ======== CALCULATION ========
    function computeTotalsRecursive(itemId, neededQty, totalsMap){
      const it = itemsById.get(String(itemId));
      const qty = Number(neededQty || 0);
      const recipe = recipeByItemId.get(String(itemId)) || [];
      const expand = it && isCraftable(it) && recipe.length > 0;

      if (!it) return;

      if (!expand){
        const key = String(itemId);
        totalsMap.set(key, (totalsMap.get(key) || 0) + qty);
        return;
      }
      for (const row of recipe){
        computeTotalsRecursive(row.component_id, qty * Number(row.qty || 0), totalsMap);
      }
    }

    // ======== LOADERS (tab-based) ========
    async function loadCategoryData(cat){
      const status = document.getElementById('statusLine');
      status.textContent = tr('loading');

      if (CACHE.items.has(cat) && CACHE.recipes.has(cat)){
        ITEMS = CACHE.items.get(cat);
        RECIPES = CACHE.recipes.get(cat);
        rebuildIndexes();
        return;
      }

      const src = URLS[cat];
      if (!src) throw new Error('Unknown category: ' + cat);

      const [itemsRaw, recipesRaw] = await Promise.all([
        loadCSV(src.items),
        loadCSV(src.recipes)
      ]);

      const items = normalizeItems(itemsRaw);
      const recipes = normalizeRecipes(recipesRaw);

      CACHE.items.set(cat, items);
      CACHE.recipes.set(cat, recipes);

      ITEMS = items;
      RECIPES = recipes;
      rebuildIndexes();
    }

    async function loadAllMergedData(){
      if (CACHE.allItems && CACHE.allRecipes) return;

      const cats = ['weapon','armor','jewelry'];
      const loads = await Promise.all(cats.map(async (c) => {
        const [itemsRaw, recipesRaw] = await Promise.all([
          loadCSV(URLS[c].items),
          loadCSV(URLS[c].recipes)
        ]);
        return { cat: c, items: normalizeItems(itemsRaw), recipes: normalizeRecipes(recipesRaw) };
      }));

      // Merge items by id
      const itemsMap = new Map();
      for (const block of loads){
        for (const it of block.items){
          if (!it.id) continue;
          if (!itemsMap.has(it.id)) itemsMap.set(it.id, it);
        }
      }

      // Merge recipes; de-dup by item_id+component_id+qty
      const recKey = (r)=>`${r.item_id}::${r.component_id}::${Number(r.qty||0)}`;
      const recSet = new Set();
      const allRecipes = [];
      for (const block of loads){
        for (const r of block.recipes){
          const k = recKey(r);
          if (recSet.has(k)) continue;
          recSet.add(k);
          allRecipes.push(r);
        }
      }

      CACHE.allItems = Array.from(itemsMap.values());
      CACHE.allRecipes = allRecipes;
    }

    // ======== FILTER UI ========
    function resetTierFilterUI(){
      activeTierFilter = 'all';
      const box = document.getElementById('tierFilter');
      if (!box) return;
      box.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      const allBtn = box.querySelector('[data-tier="all"]');
      if (allBtn) allBtn.classList.add('active');
    }

    function bindTierFilter(){
      const box = document.getElementById('tierFilter');
      if (!box) return;

      box.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          activeTierFilter = btn.dataset.tier;

          box.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          renderItemsList();
        });
      });
    }

    function updateTierCounts(sourceItems){
      const box = document.getElementById('tierFilter');
      if (!box) return;

      const counts = { C:0, B:0, A:0, S:0, S80:0, S84:0 };
      for (const it of sourceItems){
        const t = String(it.tier || '').trim().toUpperCase();
        if (counts.hasOwnProperty(t)) counts[t]++;
      }
      const total = sourceItems.length;

      box.querySelectorAll('button[data-tier]').forEach(btn => {
        const t = btn.dataset.tier;
        if (t === 'all'){
          btn.textContent = `ALL (${total})`;
        } else {
          const c = counts[t] ?? 0;
          btn.textContent = `${t} (${c})`;
        }
      });
    }

    function renderSubtypeFilter(){
      const box = document.getElementById('subtypeFilter');
      if (!box) return;

      const list = SUBTABS[activeCategory] || [];
      if (!list.length){
        box.style.display = 'none';
        return;
      }

      box.style.display = 'flex';

      let html = `<button class="btn ${activeSubtypeFilter==='all'?'active':''}" data-subtype="all">${tr('all')}</button>`;
      for (const s of list){
        const isActive = (activeSubtypeFilter !== 'all' && normKey(activeSubtypeFilter) === normKey(s));
        const label = subtypeLabel(s);
        const ic = subtypeIcon(s);
        html += `<button class="btn ${isActive?'active':''}" data-subtype="${s.replace(/"/g,'&quot;')}"><span class="subtab-icon">${ic}</span>${label}</button>`;
      }
      box.innerHTML = html;

      box.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          activeSubtypeFilter = btn.dataset.subtype || 'all';
          box.querySelectorAll('button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderItemsList();
        });
      });
    }

    // ======== FILTERING + RENDER LIST ========
    function filterItemsByActiveCategory(){
      const cat = activeCategory;

      if (cat === 'materials'){
        // ONLY materials that are craftable (from merged dataset)
        return ITEMS.filter(it =>
          String(it.category || '').toLowerCase() === 'material' &&
          isCraftable(it)
        );
      }

      // weapon | armor | jewelry
      return ITEMS.filter(it => String(it.category || '').toLowerCase() === cat);
    }

    function renderItemsList(){
      const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
      const listEl = document.getElementById('itemsList');

      const baseItems = filterItemsByActiveCategory().filter(it => {
        // search
        if (q){
          const en = (it.name_en || '').toLowerCase();
          const ru = (it.name_ru || '').toLowerCase();
          if (!en.includes(q) && !ru.includes(q)) return false;
        }

        // subtype filter (weapon/armor/jewelry only)
        if ((activeCategory === 'weapon' || activeCategory === 'armor' || activeCategory === 'jewelry') && activeSubtypeFilter !== 'all'){
          const st = normKey(it.subtype || '');
          const want = normKey(activeSubtypeFilter || '');
          if (!st || st !== want) return false;
        }

        return true;
      });

      // tier counts should reflect search+subtype (before tier filter)
      if (activeCategory === 'weapon'){
        updateTierCounts(baseItems);
      }

      // apply tier filter for weapons
      const items = baseItems.filter(it => {
        if (activeCategory === 'weapon' && activeTierFilter !== 'all'){
          const tier = String(it.tier || '').trim().toUpperCase();
          return tier === activeTierFilter;
        }
        return true;
      });

      items.sort(itemSort);

      document.getElementById('statusLine').textContent =
        `${tr('itemsCount', items.length)}  |  ${tr('icons', iconFilled, iconTotal)}`;

      listEl.innerHTML = items.map(it => {
        const isWeaponsTab = (activeCategory === 'weapon');
        const tier = String(it.tier || '').trim().toUpperCase();
        const tierCls = tier.toLowerCase();
        return `
          <div class="item-row" data-id="${String(it.id)}">
            <div class="item-left">
              ${iconOrDot(it)}
              <div class="name">${getDisplayNameBoth(it)}</div>
            </div>
            <div class="right">
              ${isWeaponsTab && tier ? `<span class="badge-tier ${tierCls}">${tier}</span>` : ``}
              <span class="badge">${String(it.category || '').toLowerCase()}</span>
            </div>
          </div>
        `;
      }).join('');

      listEl.querySelectorAll('.item-row').forEach(row => {
        row.addEventListener('click', () => openItem(row.getAttribute('data-id')));
      });
    }

    // ======== DETAILS RENDER ========
    function renderTreeView(){
      const treeEl = document.getElementById('treeView');
      treeEl.innerHTML = '';

      const craftQty = Math.max(1, Number(document.getElementById('craftQty').value || 1));
      const item = itemsById.get(String(currentItemId));
      const itemName = getDisplayName(item);

      document.getElementById('detailsTitle').textContent = tr('components', itemName, craftQty);
      setIconsInfo();

      const top = document.createElement('div');
      top.className = 'node open';
      top.innerHTML = `
        <div class="node-head">
          <div class="item-left">
            ${iconOrDot(item)}
            <div class="name">${itemName}</div>
          </div>
          <div class="right">
            <span class="badge">${String(item?.category || '').toLowerCase()}</span>
            <span class="qty">x${craftQty}</span>
          </div>
        </div>
        <div class="node-children"></div>
      `;
      treeEl.appendChild(top);

      const childrenEl = top.querySelector('.node-children');
      const recipe = recipeByItemId.get(String(currentItemId)) || [];
      if (recipe.length === 0){
        childrenEl.innerHTML = `<div class="small">${tr('noRecipe')}</div>`;
        return;
      }

      for (const row of recipe){
        const compId = String(row.component_id);
        const compQty = Number(row.qty || 0) * craftQty;
        childrenEl.appendChild(renderTreeNode(compId, compQty));
      }
    }

    function renderTreeNode(itemId, totalQty){
      const it = itemsById.get(String(itemId));
      const name = getDisplayName(it);
      const recipe = recipeByItemId.get(String(itemId)) || [];
      const canExpand = it && isCraftable(it) && recipe.length > 0;

      const wrap = document.createElement('div');
      wrap.className = 'node';
      wrap.innerHTML = `
        <div class="node-head">
          <div class="item-left">
            ${iconOrDot(it)}
            <div class="name">${name}</div>
          </div>
          <div class="right">
            <span class="badge">${canExpand ? tr('badgeCraft') : tr('badgeBase')}</span>
            ${canExpand ? `<button class="expand-btn" type="button">${tr('expand')}</button>` : `<span></span>`}
            <span class="qty">x${totalQty}</span>
          </div>
        </div>
        <div class="node-children"></div>
      `;

      if (canExpand){
        const btn = wrap.querySelector('.expand-btn');
        const childrenEl = wrap.querySelector('.node-children');

        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();

          const openNow = wrap.classList.toggle('open');
          btn.textContent = openNow ? tr('collapse') : tr('expand');

          if (openNow && childrenEl.childElementCount === 0){
            for (const r of recipe){
              const cid = String(r.component_id);
              const cqty = totalQty * Number(r.qty || 0);
              childrenEl.appendChild(renderTreeNode(cid, cqty));
            }
          }
        });
      }
      return wrap;
    }

    function renderTotalView(){
      const craftQty = Math.max(1, Number(document.getElementById('craftQty').value || 1));
      const item = itemsById.get(String(currentItemId));
      const itemName = getDisplayName(item);

      document.getElementById('detailsTitle').textContent =
        tr('totalMaterialsTitle', itemName, craftQty);

      setIconsInfo();

      const totals = new Map();
      computeTotalsRecursive(String(currentItemId), craftQty, totals);

      const rows = Array.from(totals.entries())
        .map(([id, req]) => {
          const it = itemsById.get(String(id));
          const have = Number(HAVE[id] || 0);
          const need = Math.max(0, Number(req) - have);
          const price = Number(PRICE[id] || 0);
          const cost = need * price;
          return { id, it, req: Number(req), have, need, price, cost };
        })
        .sort((a,b) => getDisplayName(a.it).localeCompare(getDisplayName(b.it)));

      const totalCost = rows.reduce((s,r)=>s+r.cost, 0);

      const sumEl = document.getElementById('costSummary');
      sumEl.innerHTML = `
        <div><div class="k">${tr('summaryCraftQty')}</div><div class="v">x${craftQty}</div></div>
        <div><div class="k">${tr('summaryTotalCost')}</div><div class="v">${formatAdena(totalCost)}</div></div>
      `;

      let html = `
        <table>
          <thead>
            <tr>
              <th>${tr('thMaterial')}</th>
              <th class="num">${tr('thRequired')}</th>
              <th class="num">${tr('thHave')}</th>
              <th class="num">${tr('thNeed')}</th>
              <th class="num">${tr('thPrice')}</th>
              <th class="num">${tr('thCost')}</th>
            </tr>
          </thead>
          <tbody>
      `;

      for (const r of rows){
        const needCls = r.need > 0 ? 'neg' : 'pos';
        html += `
          <tr data-id="${r.id}">
            <td>
              <div class="cell-name">
                ${iconOrDot(r.it)}
                <span>${getDisplayName(r.it)}</span>
              </div>
            </td>
            <td class="num">${r.req}</td>
            <td class="num">
              <input class="haveInput" type="text" inputmode="numeric" value="${String(r.have)}"
                     style="width:110px; padding:6px; font-size:13px;">
            </td>
            <td class="num ${needCls}">${r.need}</td>
            <td class="num">
              <input class="priceInput" type="text" inputmode="numeric" value="${String(r.price)}"
                     style="width:110px; padding:6px; font-size:13px;">
            </td>
            <td class="num">${formatAdena(r.cost)}</td>
          </tr>
        `;
      }

      html += `
          </tbody>
          <tfoot>
            <tr class="tfoot">
              <td colspan="5" class="num">${tr('footTotalCost')}</td>
              <td class="num">${formatAdena(totalCost)}</td>
            </tr>
          </tfoot>
        </table>
      `;

      document.getElementById('totalTableWrap').innerHTML = html;

      document.querySelectorAll('#totalTableWrap tr[data-id]').forEach(trEl => {
        const id = trEl.getAttribute('data-id');
        const haveInput = trEl.querySelector('.haveInput');
        const priceInput = trEl.querySelector('.priceInput');

        const commitHave = () => {
          const v = toNonNegInt(haveInput.value);
          HAVE[id] = v;
          saveHave();
          renderTotalView();
        };
        const commitPrice = () => {
          const v = toNonNegInt(priceInput.value);
          PRICE[id] = v;
          savePrice();
          renderTotalView();
        };

        haveInput.addEventListener('change', commitHave);
        priceInput.addEventListener('change', commitPrice);
        haveInput.addEventListener('blur', commitHave);
        priceInput.addEventListener('blur', commitPrice);

        haveInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){ e.preventDefault(); commitHave(); }
        });
        priceInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter'){ e.preventDefault(); commitPrice(); }
        });
      });
    }

    function refreshCurrentDetails(){
      if (!currentItemId) return;

      const tree = document.getElementById('treeView');
      const total = document.getElementById('totalView');

      const bTree = document.getElementById('btnTree');
      const bTotal = document.getElementById('btnTotal');

      bTree.classList.remove('active');
      bTotal.classList.remove('active');

      if (currentMode === 'tree'){
        bTree.classList.add('active');
        tree.style.display = 'block';
        total.style.display = 'none';
        renderTreeView();
      } else {
        bTotal.classList.add('active');
        tree.style.display = 'none';
        total.style.display = 'block';
        renderTotalView();
      }
    }

    function openItem(id){
      currentItemId = String(id);
      showDetails();
      currentMode = 'tree';
      refreshCurrentDetails();
    }

    async function setActiveTab(tab){
      activeCategory = tab;

      document.getElementById('tabWeapons').classList.toggle('active', tab === 'weapon');
      document.getElementById('tabArmors').classList.toggle('active', tab === 'armor');
      document.getElementById('tabJewelry').classList.toggle('active', tab === 'jewelry');
      document.getElementById('tabMaterials').classList.toggle('active', tab === 'materials');

      // show/hide tier filter
      const tf = document.getElementById('tierFilter');
      if (tf){
        if (tab === 'weapon'){
          tf.style.display = 'flex';
        } else {
          tf.style.display = 'none';
          resetTierFilterUI();
        }
      }

      // subtype subtabs
      if (tab === 'weapon' || tab === 'armor' || tab === 'jewelry'){
        const list = SUBTABS[tab] || [];
        const ok = (activeSubtypeFilter === 'all') || list.some(x => normKey(x) === normKey(activeSubtypeFilter));
        if (!ok) activeSubtypeFilter = 'all';
      } else {
        activeSubtypeFilter = 'all';
      }

      showList();

      try{
        if (tab === 'materials'){
          await loadAllMergedData();
          ITEMS = CACHE.allItems || [];
          RECIPES = CACHE.allRecipes || [];
          rebuildIndexes();
        } else {
          await loadCategoryData(tab);
        }

        renderSubtypeFilter();
        renderItemsList();
      } catch (e){
        console.error(e);
        document.getElementById('statusLine').textContent = 'Error loading tab data. Check console.';
        document.getElementById('itemsList').innerHTML = '';
      }
    }

    function bindEvents(){
      document.getElementById('searchInput').addEventListener('input', renderItemsList);

      document.getElementById('btnBack').addEventListener('click', () => {
        showList();
        renderItemsList();
      });

      document.getElementById('craftQty').addEventListener('change', () => {
        const v = Math.max(1, toNonNegInt(document.getElementById('craftQty').value));
        document.getElementById('craftQty').value = v;
        refreshCurrentDetails();
      });

      document.getElementById('btnTree').addEventListener('click', () => {
        currentMode = 'tree';
        refreshCurrentDetails();
      });

      document.getElementById('btnTotal').addEventListener('click', () => {
        currentMode = 'total';
        refreshCurrentDetails();
      });

      document.getElementById('btnReset').addEventListener('click', () => {
        HAVE = {};
        PRICE = {};
        saveHave();
        savePrice();
        refreshCurrentDetails();
      });

      document.getElementById('btnLang').addEventListener('click', () => {
        LANG = (LANG === 'en') ? 'ru' : 'en';
        saveLang();
        applyI18nStatic();

        if (!currentItemId){
          renderItemsList();
        } else {
          refreshCurrentDetails();
        }
      });

      document.getElementById('tabWeapons').addEventListener('click', () => setActiveTab('weapon'));
      document.getElementById('tabArmors').addEventListener('click', () => setActiveTab('armor'));
      document.getElementById('tabJewelry').addEventListener('click', () => setActiveTab('jewelry'));
      document.getElementById('tabMaterials').addEventListener('click', () => setActiveTab('materials'));

      bindTierFilter();
    }

    async function init(){
      loadUserData();
      applyI18nStatic();

      const status = document.getElementById('statusLine');
      status.textContent = tr('loading');

      try{
        await setActiveTab('weapon');
      } catch (e){
        console.error(e);
        status.textContent = 'Error loading data. Check console.';
      }
    }

    bindEvents();
    init();
  </script>
</body>
</html>
