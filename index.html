<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>L2 Interlude Craft Calculator</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --row:#162238;
      --row2:#1a2a44;
      --hover:#223455;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#f59e0b;
      --btn:#0b1b33;
      --btnBorder:#2b3f64;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      padding:16px;
      font-family: Arial, sans-serif;
      background: linear-gradient(180deg, var(--panel), var(--bg));
      color:var(--text);
    }
    .topbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .tab{
      background: var(--btn);
      border:1px solid var(--btnBorder);
      color: var(--text);
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .tab.active{
      border-color:#3b82f6;
      box-shadow: 0 0 0 2px rgba(59,130,246,.15) inset;
    }
    h1{
      margin:0 0 10px 0;
      font-size:18px;
      font-weight:700;
    }
    .search{
      width:100%;
      padding:10px 12px;
      font-size:16px;
      border-radius:8px;
      border:1px solid #20314f;
      background:#0b1b33;
      color:var(--text);
      outline:none;
      margin-bottom:12px;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin:6px 0 10px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: var(--row);
      border:1px solid #223455;
      padding:10px 12px;
      border-radius:10px;
      margin-bottom:8px;
    }
    .row:hover{ background: var(--hover); }
    .row.clickable{ cursor:pointer; }
    .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .icon{
      width:34px;
      height:34px;
      border-radius:8px;
      background:#0b1b33;
      border:1px solid #24385e;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .icon img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
    }
    .title{
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:14px;
      font-weight:600;
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex:0 0 auto;
      color:var(--muted);
      font-size:12px;
    }
    .qty{
      color:var(--accent);
      font-weight:800;
      font-size:14px;
      min-width:56px;
      text-align:right;
    }
    .pill{
      border:1px solid #2b3f64;
      padding:3px 8px;
      border-radius:999px;
      background:#0b1b33;
      color:var(--muted);
      font-size:11px;
    }
    .btn{
      background: var(--btn);
      border:1px solid var(--btnBorder);
      color: var(--text);
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .btn:hover{ background:#102447; }

    .backbar{
      display:flex;
      align-items:center;
      gap:10px;
      margin:8px 0 8px;
    }
    .tip{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    /* дерево */
    .tree{
      margin-top:8px;
    }
    .node{
      margin-bottom:8px;
    }
    .children{
      margin-left:22px;
      border-left:2px solid #223455;
      padding-left:10px;
      margin-top:8px;
    }
    .small{
      font-size:11px;
      color:var(--muted);
    }
    .error{
      color:#fca5a5;
      font-size:13px;
      margin-top:8px;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <h1>L2 Interlude Craft Calculator</h1>

  <div class="topbar">
    <button id="tabWeapons" class="tab active">Weapons</button>
  </div>

  <input id="search" class="search" type="text" placeholder="Search weapon (Arcana / Аркана)">

  <div id="meta" class="meta">Loading data...</div>
  <div id="content"></div>

  <script>
    /* ===== ВСТАВЬ СЮДА ССЫЛКИ CSV ===== */
    const ITEMS_URL   = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=0&single=true&output=csv';
    const RECIPES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT3_T3hm32yUCZjgm4LQekdl1hdR14IANDhfQXcw6lIJRDghavbJUFj4rYacRryxZJkSip0p54HWram/pub?gid=1962635748&single=true&output=csv';

    /* ===== STATE ===== */
    let ITEMS = [];
    let RECIPES = [];
    let itemsById = new Map();              // id -> item
    let recipeByItemId = new Map();         // item_id -> array of {item_id, component_id, qty}
    let currentView = 'weaponsList';        // weaponsList | weaponTree
    let currentWeaponId = null;
    let expanded = new Set();               // key: `${parentId}:${childId}` or just itemId for tree expand

    /* ===== CSV LOADER (supports quotes) ===== */
    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (!inQuotes && (c === ',')) { row.push(cur); cur = ''; continue; }
        if (!inQuotes && (c === '\n' || c === '\r')) {
          if (c === '\r' && next === '\n') i++;
          row.push(cur);
          rows.push(row);
          row = [];
          cur = '';
          continue;
        }
        cur += c;
      }
      if (cur.length || row.length) { row.push(cur); rows.push(row); }
      return rows;
    }

    async function loadCSV(url) {
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error(`CSV fetch failed (${res.status}) for ${url}`);
      const text = await res.text();
      const table = parseCSV(text.trim());
      if (!table.length) return [];

      const headers = table[0].map(h => h.trim());
      return table.slice(1).filter(r => r.some(x => String(x).trim() !== '')).map(r => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = (r[i] ?? '').trim());
        return obj;
      });
    }

    function normalizeItems(items) {
      // ожидаем колонки: id, name_en, name_ru, category, craftable, icon
      return items.map(x => ({
        id: String(x.id || '').trim(),
        name_en: x.name_en || '',
        name_ru: x.name_ru || '',
        category: (x.category || '').trim(),
        craftable: (x.craftable || '').trim().toLowerCase(), // yes/no
        icon: (x.icon || '').trim()
      })).filter(x => x.id);
    }

    function normalizeRecipes(recipes) {
      // ожидаем: item_id, component_id, qty
      return recipes.map(x => ({
        item_id: String(x.item_id || '').trim(),
        component_id: String(x.component_id || '').trim(),
        qty: Number(String(x.qty || '0').trim()) || 0
      })).filter(x => x.item_id && x.component_id && x.qty > 0);
    }

    function buildIndexes() {
      itemsById = new Map();
      for (const it of ITEMS) itemsById.set(it.id, it);

      recipeByItemId = new Map();
      for (const r of RECIPES) {
        if (!recipeByItemId.has(r.item_id)) recipeByItemId.set(r.item_id, []);
        recipeByItemId.get(r.item_id).push(r);
      }
    }

    function iconHTML(item) {
      const url = item?.icon && item.icon.startsWith('http') ? item.icon : '';
      if (!url) return `<div class="icon"></div>`;
      // onerror -> fallback to empty box
      return `
        <div class="icon">
          <img src="${url}" alt="" loading="lazy"
               onerror="this.closest('.icon').innerHTML='';">
        </div>
      `;
    }

    function el(tag, html) {
      const d = document.createElement(tag);
      if (html !== undefined) d.innerHTML = html;
      return d;
    }

    function setMeta(text) {
      document.getElementById('meta').textContent = text;
    }

    function renderWeaponsList() {
      currentView = 'weaponsList';
      currentWeaponId = null;

      const q = document.getElementById('search').value.trim().toLowerCase();
      const weapons = ITEMS.filter(it => it.category === 'weapon');
      const filtered = weapons.filter(it => {
        if (!q) return true;
        return (it.name_en || '').toLowerCase().includes(q) || (it.name_ru || '').toLowerCase().includes(q);
      });

      const iconsFilled = weapons.reduce((acc, it) => acc + (it.icon && it.icon.startsWith('http') ? 1 : 0), 0);

      setMeta(`Weapons: ${filtered.length} | Icons filled: ${iconsFilled}/${weapons.length}`);

      const content = document.getElementById('content');
      content.innerHTML = '';

      if (!weapons.length) {
        content.appendChild(el('div', `<div class="error">No weapons found. Проверь в таблице Items: у оружия category должно быть "weapon".</div>`));
        return;
      }

      for (const it of filtered) {
        const row = el('div');
        row.className = 'row clickable';
        row.innerHTML = `
          <div class="left">
            ${iconHTML(it)}
            <div class="title">${it.name_en} — ${it.name_ru}</div>
          </div>
          <div class="right">
            <span class="pill">${it.category}</span>
          </div>
        `;
        row.addEventListener('click', () => {
          currentWeaponId = it.id;
          expanded.clear();
          renderWeaponTree(it.id);
        });
        content.appendChild(row);
      }
    }

    function renderWeaponTree(weaponId) {
      currentView = 'weaponTree';
      const weapon = itemsById.get(String(weaponId));

      const content = document.getElementById('content');
      content.innerHTML = '';

      const backbar = el('div');
      backbar.className = 'backbar';
      backbar.innerHTML = `<button class="btn" id="backBtn">◀ Back</button><div class="small">Components: ${weapon?.name_en || ''} — ${weapon?.name_ru || ''}</div>`;
      content.appendChild(backbar);

      document.getElementById('backBtn').addEventListener('click', () => renderWeaponsList());

      if (!weapon) {
        content.appendChild(el('div', `<div class="error">Weapon not found by id=${weaponId}</div>`));
        return;
      }

      // Корень дерева — сам weapon (qty=1)
      const tree = el('div');
      tree.className = 'tree';
      tree.appendChild(renderNode(weapon.id, 1, 0, true)); // forceShowChildren=true for root
      content.appendChild(tree);

      content.appendChild(el('div', `<div class="tip">Tip: Click Expand to раскрыть крафт компонента (qty умножается).</div>`));
    }

    function hasRecipe(itemId) {
      const arr = recipeByItemId.get(String(itemId));
      return Array.isArray(arr) && arr.length > 0;
    }

    function isCraftable(item) {
      return (item?.craftable || '').toLowerCase() === 'yes';
    }

    function renderNode(itemId, qty, depth, forceShowChildren = false) {
      const item = itemsById.get(String(itemId)) || { id: String(itemId), name_en: `Unknown #${itemId}`, name_ru: '', category: 'unknown', craftable: 'no', icon: '' };
      const canExpand = isCraftable(item) && hasRecipe(item.id);

      const node = el('div');
      node.className = 'node';

      // key для expand/collapse
      const key = String(item.id);
      const opened = forceShowChildren ? true : expanded.has(key);

      const row = el('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="left">
          ${iconHTML(item)}
          <div class="title">${item.name_en} — ${item.name_ru}</div>
        </div>
        <div class="right">
          <span class="pill">${item.category || 'item'}</span>
          <span class="pill">${canExpand ? (opened ? 'expanded' : 'craftable') : 'base'}</span>
          <div class="qty">x${qty}</div>
          ${canExpand && !forceShowChildren ? `<button class="btn">${opened ? 'Collapse' : 'Expand'}</button>` : ``}
        </div>
      `;
      node.appendChild(row);

      if (canExpand && !forceShowChildren) {
        const btn = row.querySelector('button.btn');
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (expanded.has(key)) expanded.delete(key);
          else expanded.add(key);
          // перерисовать всю страницу дерева
          renderWeaponTree(currentWeaponId);
        });
      }

      // дети
      const shouldShowChildren = forceShowChildren || (canExpand && opened);
      if (shouldShowChildren) {
        const parts = recipeByItemId.get(String(item.id)) || [];
        if (parts.length) {
          const children = el('div');
          children.className = 'children';

          for (const p of parts) {
            const childId = p.component_id;
            const childQty = qty * p.qty; // умножаем
            const childItem = itemsById.get(String(childId));
            const childCanExpand = isCraftable(childItem) && hasRecipe(childId);

            // Рендерим ребёнка
            // Если ребёнок craftable, то он показывается свернутым, пока ты не Expand его
            children.appendChild(renderNode(childId, childQty, depth + 1, false));
          }
          node.appendChild(children);
        }
      }

      return node;
    }

    async function init() {
      try {
        setMeta('Loading data...');
        const itemsRaw = await loadCSV(ITEMS_URL);
        const recipesRaw = await loadCSV(RECIPES_URL);

        ITEMS = normalizeItems(itemsRaw);
        RECIPES = normalizeRecipes(recipesRaw);
        buildIndexes();

        console.log('ITEMS:', ITEMS);
        console.log('RECIPES:', RECIPES);

        // Telegram
        const tg = window.Telegram?.WebApp;
        if (tg) tg.ready();

        renderWeaponsList();

      } catch (err) {
        console.error(err);
        setMeta('Error');
        document.getElementById('content').innerHTML = `<div class="error">${String(err)}</div>`;
      }
    }

    // search handler
    document.getElementById('search').addEventListener('input', () => {
      if (currentView === 'weaponsList') renderWeaponsList();
    });

    // tab (пока одна вкладка)
    document.getElementById('tabWeapons').addEventListener('click', () => {
      document.getElementById('tabWeapons').classList.add('active');
      expanded.clear();
      renderWeaponsList();
    });

    init();
  </script>
</body>
</html>
